var mn=Object.defineProperty;var Nr=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,r)=>(typeof require<"u"?require:e)[r]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+t+'" is not supported')});var ft=(t,e)=>()=>(t&&(e=t(t=0)),e);var fn=(t,e)=>{for(var r in e)mn(t,r,{get:e[r],enumerable:!0})};import{int as i,mysqlEnum as D,mysqlTable as A,text as w,timestamp as p,varchar as c,boolean as k,date as W}from"drizzle-orm/mysql-core";var O,T,E,R,M,Z,ce,Ee,oe,V,ye,Ne,ue,q,xr,Q,qs,gt,ve,Re,$s,G,Hs,xe,Te,Be,Fs,j,Tr,je,Dr,x,he,Ms,P,Y,N,Ks,Me=ft(()=>{"use strict";O=A("users",{id:i("id").autoincrement().primaryKey(),openId:c("openId",{length:64}).notNull().unique(),name:w("name"),email:c("email",{length:320}),passwordHash:c("passwordHash",{length:255}),emailVerified:k("emailVerified").default(!1),resetToken:c("resetToken",{length:255}),resetTokenExpiry:p("resetTokenExpiry"),loginMethod:c("loginMethod",{length:64}),role:D("role",["user","admin"]).default("user").notNull(),subscriptionStatus:D("subscriptionStatus",["trial","active","cancelled","overdue","expired"]).default("trial").notNull(),subscriptionPlan:D("subscriptionPlan",["monthly","yearly"]).default("monthly"),stripeCustomerId:c("stripeCustomerId",{length:255}),stripeSubscriptionId:c("stripeSubscriptionId",{length:255}),trialEndsAt:p("trialEndsAt"),subscriptionEndsAt:p("subscriptionEndsAt"),lastPaymentAt:p("lastPaymentAt"),isActive:k("isActive").default(!0).notNull(),isSuspended:k("isSuspended").default(!1).notNull(),suspendedReason:w("suspendedReason"),phone:c("phone",{length:20}),location:c("location",{length:255}),profileImageUrl:w("profileImageUrl"),preferences:w("preferences"),language:c("language",{length:10}).default("en"),theme:D("theme",["light","dark","system"]).default("system"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull(),lastSignedIn:p("lastSignedIn").defaultNow().notNull()}),T=A("horses",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),name:c("name",{length:100}).notNull(),breed:c("breed",{length:100}),age:i("age"),dateOfBirth:W("dateOfBirth"),height:i("height"),weight:i("weight"),color:c("color",{length:50}),gender:D("gender",["stallion","mare","gelding"]),discipline:c("discipline",{length:100}),level:c("level",{length:50}),registrationNumber:c("registrationNumber",{length:100}),microchipNumber:c("microchipNumber",{length:100}),notes:w("notes"),photoUrl:w("photoUrl"),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),E=A("healthRecords",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),recordType:D("recordType",["vaccination","deworming","dental","farrier","veterinary","injury","medication","other"]).notNull(),title:c("title",{length:200}).notNull(),description:w("description"),recordDate:W("recordDate").notNull(),nextDueDate:W("nextDueDate"),vetName:c("vetName",{length:100}),vetPhone:c("vetPhone",{length:20}),vetClinic:c("vetClinic",{length:200}),cost:i("cost"),documentUrl:w("documentUrl"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),R=A("trainingSessions",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),sessionDate:W("sessionDate").notNull(),startTime:c("startTime",{length:10}),endTime:c("endTime",{length:10}),duration:i("duration"),sessionType:D("sessionType",["flatwork","jumping","hacking","lunging","groundwork","competition","lesson","other"]).notNull(),discipline:c("discipline",{length:100}),trainer:c("trainer",{length:100}),location:c("location",{length:200}),goals:w("goals"),exercises:w("exercises"),notes:w("notes"),performance:D("performance",["excellent","good","average","poor"]),weather:c("weather",{length:100}),temperature:i("temperature"),isCompleted:k("isCompleted").default(!1).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),M=A("feedingPlans",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),feedType:c("feedType",{length:100}).notNull(),brandName:c("brandName",{length:100}),quantity:c("quantity",{length:50}).notNull(),unit:c("unit",{length:20}),mealTime:D("mealTime",["morning","midday","evening","night"]).notNull(),frequency:c("frequency",{length:50}).default("daily"),specialInstructions:w("specialInstructions"),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Z=A("documents",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId"),healthRecordId:i("healthRecordId"),fileName:c("fileName",{length:255}).notNull(),fileType:c("fileType",{length:50}).notNull(),fileSize:i("fileSize"),fileUrl:w("fileUrl").notNull(),fileKey:c("fileKey",{length:500}).notNull(),category:D("category",["health","registration","insurance","competition","other"]).default("other"),description:w("description"),createdAt:p("createdAt").defaultNow().notNull()}),ce=A("weatherLogs",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),location:c("location",{length:255}).notNull(),temperature:i("temperature"),humidity:i("humidity"),windSpeed:i("windSpeed"),precipitation:i("precipitation"),conditions:c("conditions",{length:100}),uvIndex:i("uvIndex"),visibility:i("visibility"),ridingRecommendation:D("ridingRecommendation",["excellent","good","fair","poor","not_recommended"]),aiAnalysis:w("aiAnalysis"),checkedAt:p("checkedAt").defaultNow().notNull()}),Ee=A("systemSettings",{id:i("id").autoincrement().primaryKey(),settingKey:c("settingKey",{length:100}).notNull().unique(),settingValue:w("settingValue"),settingType:D("settingType",["string","number","boolean","json"]).default("string"),description:w("description"),isEncrypted:k("isEncrypted").default(!1),updatedBy:i("updatedBy"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),oe=A("adminSessions",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),expiresAt:p("expiresAt").notNull(),createdAt:p("createdAt").defaultNow().notNull()}),V=A("adminUnlockAttempts",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull().unique(),attempts:i("attempts").default(0).notNull(),lockedUntil:p("lockedUntil"),lastAttemptAt:p("lastAttemptAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),ye=A("activityLogs",{id:i("id").autoincrement().primaryKey(),userId:i("userId"),action:c("action",{length:100}).notNull(),entityType:c("entityType",{length:50}),entityId:i("entityId"),details:w("details"),ipAddress:c("ipAddress",{length:45}),userAgent:w("userAgent"),createdAt:p("createdAt").defaultNow().notNull()}),Ne=A("backupLogs",{id:i("id").autoincrement().primaryKey(),backupType:D("backupType",["full","incremental","users","horses"]).notNull(),status:D("status",["pending","running","completed","failed"]).notNull(),fileName:c("fileName",{length:255}),fileSize:i("fileSize"),fileUrl:w("fileUrl"),errorMessage:w("errorMessage"),startedAt:p("startedAt").defaultNow().notNull(),completedAt:p("completedAt")}),ue=A("stables",{id:i("id").autoincrement().primaryKey(),name:c("name",{length:200}).notNull(),description:w("description"),ownerId:i("ownerId").notNull(),location:c("location",{length:255}),logo:w("logo"),primaryColor:c("primaryColor",{length:7}),secondaryColor:c("secondaryColor",{length:7}),customDomain:c("customDomain",{length:255}),branding:w("branding"),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),q=A("stableMembers",{id:i("id").autoincrement().primaryKey(),stableId:i("stableId").notNull(),userId:i("userId").notNull(),role:D("role",["owner","admin","trainer","member","viewer"]).notNull(),permissions:w("permissions"),isActive:k("isActive").default(!0).notNull(),joinedAt:p("joinedAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),xr=A("stableInvites",{id:i("id").autoincrement().primaryKey(),stableId:i("stableId").notNull(),invitedByUserId:i("invitedByUserId").notNull(),email:c("email",{length:320}).notNull(),role:D("role",["admin","trainer","member","viewer"]).notNull(),token:c("token",{length:100}).notNull().unique(),status:D("status",["pending","accepted","declined","expired"]).default("pending").notNull(),expiresAt:p("expiresAt").notNull(),acceptedAt:p("acceptedAt"),createdAt:p("createdAt").defaultNow().notNull()}),Q=A("events",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),horseId:i("horseId"),title:c("title",{length:200}).notNull(),description:w("description"),eventType:D("eventType",["training","competition","veterinary","farrier","lesson","meeting","other"]).notNull(),startDate:p("startDate").notNull(),endDate:p("endDate"),location:c("location",{length:255}),isAllDay:k("isAllDay").default(!1).notNull(),isRecurring:k("isRecurring").default(!1).notNull(),recurrenceRule:w("recurrenceRule"),color:c("color",{length:7}),isCompleted:k("isCompleted").default(!1).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),qs=A("eventReminders",{id:i("id").autoincrement().primaryKey(),eventId:i("eventId").notNull(),userId:i("userId").notNull(),reminderTime:p("reminderTime").notNull(),reminderType:D("reminderType",["email","push","sms"]).notNull(),isSent:k("isSent").default(!1).notNull(),sentAt:p("sentAt"),createdAt:p("createdAt").defaultNow().notNull()}),gt=A("feedCosts",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId"),feedType:c("feedType",{length:100}).notNull(),brandName:c("brandName",{length:100}),quantity:c("quantity",{length:50}).notNull(),unit:c("unit",{length:20}),costPerUnit:i("costPerUnit").notNull(),purchaseDate:W("purchaseDate").notNull(),supplier:c("supplier",{length:200}),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull()}),ve=A("vaccinations",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),vaccineName:c("vaccineName",{length:200}).notNull(),vaccineType:c("vaccineType",{length:100}),dateAdministered:W("dateAdministered").notNull(),nextDueDate:W("nextDueDate"),batchNumber:c("batchNumber",{length:100}),vetName:c("vetName",{length:100}),vetClinic:c("vetClinic",{length:200}),cost:i("cost"),notes:w("notes"),documentUrl:w("documentUrl"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Re=A("dewormings",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),productName:c("productName",{length:200}).notNull(),activeIngredient:c("activeIngredient",{length:200}),dateAdministered:W("dateAdministered").notNull(),nextDueDate:W("nextDueDate"),dosage:c("dosage",{length:100}),weight:i("weight"),cost:i("cost"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),$s=A("shareLinks",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId"),linkType:D("linkType",["horse","stable","medical_passport"]).notNull(),token:c("token",{length:100}).notNull().unique(),isPublic:k("isPublic").default(!1).notNull(),isActive:k("isActive").default(!0).notNull(),expiresAt:p("expiresAt"),viewCount:i("viewCount").default(0).notNull(),lastViewedAt:p("lastViewedAt"),settings:w("settings"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),G=A("competitions",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),horseId:i("horseId").notNull(),competitionName:c("competitionName",{length:200}).notNull(),venue:c("venue",{length:200}),date:W("date").notNull(),discipline:c("discipline",{length:100}),level:c("level",{length:50}),class:c("class",{length:100}),placement:c("placement",{length:50}),score:c("score",{length:50}),notes:w("notes"),cost:i("cost"),winnings:i("winnings"),documentUrl:w("documentUrl"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Hs=A("documentTags",{id:i("id").autoincrement().primaryKey(),documentId:i("documentId").notNull(),tag:c("tag",{length:50}).notNull(),createdAt:p("createdAt").defaultNow().notNull()}),xe=A("stripeEvents",{id:i("id").autoincrement().primaryKey(),eventId:c("eventId",{length:255}).notNull().unique(),eventType:c("eventType",{length:100}).notNull(),processed:k("processed").default(!1).notNull(),payload:w("payload"),error:w("error"),createdAt:p("createdAt").defaultNow().notNull(),processedAt:p("processedAt")}),Te=A("messageThreads",{id:i("id").autoincrement().primaryKey(),stableId:i("stableId").notNull(),title:c("title",{length:200}),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Be=A("messages",{id:i("id").autoincrement().primaryKey(),threadId:i("threadId").notNull(),senderId:i("senderId").notNull(),content:w("content").notNull(),attachments:w("attachments"),isRead:k("isRead").default(!1).notNull(),createdAt:p("createdAt").defaultNow().notNull()}),Fs=A("competitionResults",{id:i("id").autoincrement().primaryKey(),competitionId:i("competitionId").notNull(),userId:i("userId").notNull(),horseId:i("horseId").notNull(),roundNumber:i("roundNumber").default(1),score:c("score",{length:50}),penalties:i("penalties"),time:c("time",{length:20}),judgeScores:w("judgeScores"),technicalScore:i("technicalScore"),artisticScore:i("artisticScore"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull()}),j=A("trainingProgramTemplates",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),name:c("name",{length:200}).notNull(),description:w("description"),duration:i("duration"),discipline:c("discipline",{length:100}),level:c("level",{length:50}),goals:w("goals"),programData:w("programData").notNull(),isPublic:k("isPublic").default(!1).notNull(),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Tr=A("trainingPrograms",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),userId:i("userId").notNull(),templateId:i("templateId"),name:c("name",{length:200}).notNull(),startDate:W("startDate").notNull(),endDate:W("endDate"),status:D("status",["active","completed","paused","cancelled"]).default("active").notNull(),progress:i("progress").default(0),programData:w("programData").notNull(),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),je=A("reports",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),horseId:i("horseId"),reportType:D("reportType",["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]).notNull(),title:c("title",{length:200}).notNull(),reportData:w("reportData").notNull(),fileUrl:w("fileUrl"),generatedAt:p("generatedAt").defaultNow().notNull()}),Dr=A("reportSchedules",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),reportType:D("reportType",["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]).notNull(),frequency:D("frequency",["daily","weekly","monthly","quarterly"]).notNull(),recipients:w("recipients"),isActive:k("isActive").default(!0).notNull(),lastRunAt:p("lastRunAt"),nextRunAt:p("nextRunAt"),createdAt:p("createdAt").defaultNow().notNull()}),x=A("breeding",{id:i("id").autoincrement().primaryKey(),mareId:i("mareId").notNull(),stallionId:i("stallionId"),stallionName:c("stallionName",{length:200}),breedingDate:W("breedingDate").notNull(),method:D("method",["natural","artificial","embryo_transfer"]).notNull(),veterinarianName:c("veterinarianName",{length:100}),cost:i("cost"),pregnancyConfirmed:k("pregnancyConfirmed").default(!1),confirmationDate:W("confirmationDate"),dueDate:W("dueDate"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),he=A("foals",{id:i("id").autoincrement().primaryKey(),breedingId:i("breedingId").notNull(),horseId:i("horseId"),birthDate:W("birthDate").notNull(),gender:D("gender",["colt","filly"]),name:c("name",{length:100}),color:c("color",{length:50}),markings:w("markings"),birthWeight:i("birthWeight"),currentWeight:i("currentWeight"),healthStatus:c("healthStatus",{length:100}),milestones:w("milestones"),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Ms=A("pedigree",{id:i("id").autoincrement().primaryKey(),horseId:i("horseId").notNull(),sireId:i("sireId"),sireName:c("sireName",{length:200}),damId:i("damId"),damName:c("damName",{length:200}),sireOfSireId:i("sireOfSireId"),sireOfSireName:c("sireOfSireName",{length:200}),damOfSireId:i("damOfSireId"),damOfSireName:c("damOfSireName",{length:200}),sireOfDamId:i("sireOfDamId"),sireOfDamName:c("sireOfDamName",{length:200}),damOfDamId:i("damOfDamId"),damOfDamName:c("damOfDamName",{length:200}),geneticInfo:w("geneticInfo"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),P=A("lessonBookings",{id:i("id").autoincrement().primaryKey(),trainerId:i("trainerId").notNull(),clientId:i("clientId").notNull(),horseId:i("horseId"),lessonDate:p("lessonDate").notNull(),duration:i("duration").notNull(),lessonType:c("lessonType",{length:100}),location:c("location",{length:200}),status:D("status",["scheduled","completed","cancelled","no_show"]).default("scheduled").notNull(),fee:i("fee"),paid:k("paid").default(!1).notNull(),notes:w("notes"),createdAt:p("createdAt").defaultNow().notNull(),updatedAt:p("updatedAt").defaultNow().onUpdateNow().notNull()}),Y=A("trainerAvailability",{id:i("id").autoincrement().primaryKey(),trainerId:i("trainerId").notNull(),dayOfWeek:i("dayOfWeek").notNull(),startTime:c("startTime",{length:5}).notNull(),endTime:c("endTime",{length:5}).notNull(),isActive:k("isActive").default(!0).notNull(),createdAt:p("createdAt").defaultNow().notNull()}),N=A("apiKeys",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),name:c("name",{length:100}).notNull(),keyHash:c("keyHash",{length:255}).notNull(),keyPrefix:c("keyPrefix",{length:20}).notNull(),permissions:w("permissions"),rateLimit:i("rateLimit").default(100).notNull(),isActive:k("isActive").default(!0).notNull(),lastUsedAt:p("lastUsedAt"),expiresAt:p("expiresAt"),createdAt:p("createdAt").defaultNow().notNull()}),Ks=A("webhooks",{id:i("id").autoincrement().primaryKey(),userId:i("userId").notNull(),stableId:i("stableId"),url:w("url").notNull(),events:w("events").notNull(),secret:c("secret",{length:255}).notNull(),isActive:k("isActive").default(!0).notNull(),lastTriggeredAt:p("lastTriggeredAt"),failureCount:i("failureCount").default(0),createdAt:p("createdAt").defaultNow().notNull()})});import{config as yt}from"dotenv";import{existsSync as gn}from"fs";import{resolve as yn}from"path";function hn(){let t=[{name:"DATABASE_URL",description:"Database connection string"},{name:"JWT_SECRET",description:"JWT secret for token signing"},{name:"ADMIN_UNLOCK_PASSWORD",description:"Admin unlock password"}],e=[];t.forEach(s=>{process.env[s.name]||e.push(s)}),We&&[{name:"STRIPE_SECRET_KEY",description:"Stripe secret key"},{name:"STRIPE_WEBHOOK_SECRET",description:"Stripe webhook secret"}].forEach(o=>{process.env[o.name]||e.push(o)}),Ve&&[{name:"BUILT_IN_FORGE_API_URL",description:"Forge API URL"},{name:"BUILT_IN_FORGE_API_KEY",description:"Forge API key"}].forEach(o=>{process.env[o.name]||e.push(o)}),e.length>0&&(console.error(`\u274C STARTUP ERROR: Missing required environment variables
`),console.error(`The following required environment variables are not set:
`),e.forEach(s=>{console.error(`  \u2022 ${s.name} - ${s.description}`)}),console.error(`
Feature flags:`),console.error(`  \u2022 ENABLE_STRIPE=${We}`),console.error(`  \u2022 ENABLE_UPLOADS=${Ve}`),console.error(`
Please configure all required environment variables in your .env file.`),console.error(`See .env.example for a complete list of available options.
`),process.exit(1)),Ke&&(process.env.ADMIN_UNLOCK_PASSWORD==="ashmor12@"||process.env.ADMIN_UNLOCK_PASSWORD==="EquiProfile2026!Admin")&&(console.error("\u274C PRODUCTION ERROR: ADMIN_UNLOCK_PASSWORD is still set to default value!"),console.error("You MUST change this to a secure password before running in production."),console.error(`Generate a secure password and update your .env file.
`),process.exit(1)),Ke&&["FHnuavgCmZtlXQ2AAxgq+bmpt6D4Iqfl","your_secure_jwt_secret_here","your_super_secret_jwt_key_change_this_in_production"].includes(process.env.JWT_SECRET||"")&&(console.error("\u274C PRODUCTION ERROR: JWT_SECRET is still set to a default value!"),console.error("Generate a secure secret with: openssl rand -base64 32"),console.error(`Update your .env file before running in production.
`),process.exit(1)),process.env.OAUTH_SERVER_URL?process.env.VITE_APP_ID?console.log("\u2705 OAuth configured:",process.env.OAUTH_SERVER_URL):(console.warn("\u26A0\uFE0F  WARNING: OAUTH_SERVER_URL is set but VITE_APP_ID is missing."),console.warn(`   OAuth login will not work correctly without an app ID.
`)):console.log("\u2139\uFE0F  OAuth not configured - using email/password authentication only"),console.log("\u2139\uFE0F  Feature flags:"),console.log(`   \u2022 Stripe billing: ${We?"\u2705 enabled":"\u274C disabled"}`),console.log(`   \u2022 Document uploads: ${Ve?"\u2705 enabled":"\u274C disabled"}`),Ke&&process.env.JWT_SECRET&&process.env.JWT_SECRET.length<32&&(console.error("\u274C PRODUCTION ERROR: JWT_SECRET must be at least 32 characters long!"),console.error(`Generate a secure secret with: openssl rand -base64 32
`),process.exit(1))}var Ke,We,Ve,y,ee=ft(()=>{"use strict";Ke=process.env.NODE_ENV==="production";if(Ke)yt();else{yt();let t=yn(process.cwd(),".env.default");gn(t)&&yt({path:t,override:!1})}We=process.env.ENABLE_STRIPE==="true",Ve=process.env.ENABLE_UPLOADS==="true";hn();y={enableStripe:We,enableUploads:Ve,appId:process.env.VITE_APP_ID??"",cookieSecret:process.env.JWT_SECRET??"",databaseUrl:process.env.DATABASE_URL??"",oAuthServerUrl:process.env.OAUTH_SERVER_URL??"",ownerOpenId:process.env.OWNER_OPEN_ID??"",isProduction:process.env.NODE_ENV==="production",forgeApiUrl:process.env.BUILT_IN_FORGE_API_URL??"",forgeApiKey:process.env.BUILT_IN_FORGE_API_KEY??"",adminUnlockPassword:process.env.ADMIN_UNLOCK_PASSWORD??"ashmor12@",baseUrl:process.env.BASE_URL??"http://localhost:3000",cookieDomain:process.env.COOKIE_DOMAIN??void 0,cookieSecure:process.env.COOKIE_SECURE==="true",stripeSecretKey:process.env.STRIPE_SECRET_KEY??"",stripeWebhookSecret:process.env.STRIPE_WEBHOOK_SECRET??"",awsAccessKeyId:process.env.AWS_ACCESS_KEY_ID??"",awsSecretAccessKey:process.env.AWS_SECRET_ACCESS_KEY??"",awsRegion:process.env.AWS_REGION??"eu-west-2",awsS3Bucket:process.env.AWS_S3_BUCKET??"",openaiApiKey:process.env.OPENAI_API_KEY??""}});var Ie={};fn(Ie,{createAdminSession:()=>Zt,createApiKey:()=>ir,createBackupLog:()=>In,createCompetition:()=>Rn,createDeworming:()=>Nn,createDocument:()=>$t,createFeedingPlan:()=>Bt,createHealthRecord:()=>Tt,createHorse:()=>Nt,createStripeEvent:()=>Qt,createTrainingSession:()=>Ot,createVaccination:()=>Sn,createWeatherLog:()=>Mt,deleteDocument:()=>Ft,deleteFeedingPlan:()=>qt,deleteHealthRecord:()=>kt,deleteHorse:()=>xt,deleteTrainingSession:()=>Ct,deleteUser:()=>At,getActivityLogs:()=>Jt,getAdminSession:()=>st,getAllSettings:()=>Vt,getAllUsers:()=>be,getCompetitionsByHorseId:()=>xn,getCompetitionsByUserId:()=>Tn,getDb:()=>l,getDewormingsByHorseId:()=>vn,getDocumentsByHorseId:()=>Ht,getDocumentsByUserId:()=>tt,getExpiredTrials:()=>Et,getFeedingPlansByHorseId:()=>jt,getFeedingPlansByUserId:()=>et,getHealthRecordById:()=>_t,getHealthRecordsByHorseId:()=>Dt,getHealthRecordsByUserId:()=>Ye,getHorseById:()=>vt,getHorsesByUserId:()=>_e,getLatestWeatherLog:()=>rt,getOverdueSubscriptions:()=>St,getRecentBackups:()=>Yt,getSetting:()=>bn,getSystemStats:()=>zt,getTrainingSessionsByHorseId:()=>Pt,getTrainingSessionsByUserId:()=>Qe,getUnlockAttempts:()=>tr,getUnlockLockoutTime:()=>or,getUpcomingReminders:()=>ze,getUpcomingTrainingSessions:()=>Xe,getUserActivityLogs:()=>Gt,getUserByEmail:()=>Le,getUserById:()=>X,getUserByOpenId:()=>De,getVaccinationsByHorseId:()=>En,getWeatherHistory:()=>Kt,incrementUnlockAttempts:()=>rr,isStripeEventProcessed:()=>Xt,listApiKeys:()=>ar,logActivity:()=>L,markStripeEventProcessed:()=>nt,resetUnlockAttempts:()=>nr,revokeAdminSession:()=>er,revokeApiKey:()=>lr,rotateApiKey:()=>dr,setUnlockLockout:()=>sr,suspendUser:()=>bt,unsuspendUser:()=>It,updateApiKeySettings:()=>cr,updateBackupLog:()=>An,updateFeedingPlan:()=>Lt,updateHealthRecord:()=>Ut,updateHorse:()=>Rt,updateTrainingSession:()=>Ze,updateUser:()=>J,upsertSetting:()=>Wt,upsertUser:()=>we,verifyApiKey:()=>Dn});import{eq as u,and as v,desc as F,sql as re,gte as ht,lte as _r}from"drizzle-orm";import{drizzle as wn}from"drizzle-orm/mysql2";import wt from"bcrypt";import{nanoid as Ge}from"nanoid";async function l(){if(!Je&&process.env.DATABASE_URL)try{Je=wn(process.env.DATABASE_URL)}catch(t){console.warn("[Database] Failed to connect:",t),Je=null}return Je}async function we(t){if(!t.openId)throw new Error("User openId is required for upsert");let e=await l();if(!e){console.warn("[Database] Cannot upsert user: database not available");return}try{let r={openId:t.openId},s={},o=["name","email","loginMethod"],a=d=>{let m=t[d];if(m===void 0)return;let h=m??null;r[d]=h,s[d]=h};if(o.forEach(a),t.lastSignedIn!==void 0&&(r.lastSignedIn=t.lastSignedIn,s.lastSignedIn=t.lastSignedIn),t.role!==void 0?(r.role=t.role,s.role=t.role):t.openId===y.ownerOpenId&&(r.role="admin",s.role="admin"),!r.trialEndsAt){let d=new Date;d.setDate(d.getDate()+7),r.trialEndsAt=d,r.subscriptionStatus="trial"}r.lastSignedIn||(r.lastSignedIn=new Date),Object.keys(s).length===0&&(s.lastSignedIn=new Date),await e.insert(O).values(r).onDuplicateKeyUpdate({set:s})}catch(r){throw console.error("[Database] Failed to upsert user:",r),r}}async function De(t){let e=await l();if(!e)return;let r=await e.select().from(O).where(u(O.openId,t)).limit(1);return r.length>0?r[0]:void 0}async function X(t){let e=await l();if(!e)return;let r=await e.select().from(O).where(u(O.id,t)).limit(1);return r.length>0?r[0]:void 0}async function Le(t){let e=await l();if(!e)return;let r=await e.select().from(O).where(u(O.email,t)).limit(1);return r.length>0?r[0]:void 0}async function be(){let t=await l();return t?t.select().from(O).orderBy(F(O.createdAt)):[]}async function J(t,e){let r=await l();r&&await r.update(O).set({...e,updatedAt:new Date}).where(u(O.id,t))}async function bt(t,e){let r=await l();r&&await r.update(O).set({isSuspended:!0,suspendedReason:e,updatedAt:new Date}).where(u(O.id,t))}async function It(t){let e=await l();e&&await e.update(O).set({isSuspended:!1,suspendedReason:null,updatedAt:new Date}).where(u(O.id,t))}async function At(t){let e=await l();e&&await e.update(O).set({isActive:!1,updatedAt:new Date}).where(u(O.id,t))}async function St(){let t=await l();if(!t)return[];let e=new Date;return t.select().from(O).where(v(u(O.subscriptionStatus,"overdue"),u(O.isActive,!0)))}async function Et(){let t=await l();if(!t)return[];let e=new Date;return t.select().from(O).where(v(u(O.subscriptionStatus,"trial"),_r(O.trialEndsAt,e),u(O.isActive,!0)))}async function Nt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(T).values(t))[0].insertId}async function _e(t){let e=await l();return e?e.select().from(T).where(v(u(T.userId,t),u(T.isActive,!0))).orderBy(F(T.createdAt)):[]}async function vt(t,e){let r=await l();if(!r)return;let s=await r.select().from(T).where(v(u(T.id,t),u(T.userId,e))).limit(1);return s.length>0?s[0]:void 0}async function Rt(t,e,r){let s=await l();s&&await s.update(T).set({...r,updatedAt:new Date}).where(v(u(T.id,t),u(T.userId,e)))}async function xt(t,e){let r=await l();r&&await r.update(T).set({isActive:!1,updatedAt:new Date}).where(v(u(T.id,t),u(T.userId,e)))}async function Tt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(E).values(t))[0].insertId}async function Ye(t){let e=await l();return e?e.select().from(E).where(u(E.userId,t)).orderBy(F(E.recordDate)):[]}async function Dt(t,e){let r=await l();return r?r.select().from(E).where(v(u(E.horseId,t),u(E.userId,e))).orderBy(F(E.recordDate)):[]}async function _t(t,e){let r=await l();if(!r)return;let s=await r.select().from(E).where(v(u(E.id,t),u(E.userId,e))).limit(1);return s.length>0?s[0]:void 0}async function Ut(t,e,r){let s=await l();s&&await s.update(E).set({...r,updatedAt:new Date}).where(v(u(E.id,t),u(E.userId,e)))}async function kt(t,e){let r=await l();r&&await r.delete(E).where(v(u(E.id,t),u(E.userId,e)))}async function ze(t,e=30){let r=await l();if(!r)return[];let s=new Date,o=new Date;return o.setDate(o.getDate()+e),r.select().from(E).where(v(u(E.userId,t),ht(E.nextDueDate,s),_r(E.nextDueDate,o))).orderBy(E.nextDueDate)}async function Ot(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(R).values(t))[0].insertId}async function Pt(t,e){let r=await l();return r?r.select().from(R).where(v(u(R.horseId,t),u(R.userId,e))).orderBy(F(R.sessionDate)):[]}async function Qe(t){let e=await l();return e?e.select().from(R).where(u(R.userId,t)).orderBy(F(R.sessionDate)):[]}async function Xe(t){let e=await l();if(!e)return[];let r=new Date;return e.select().from(R).where(v(u(R.userId,t),ht(R.sessionDate,r),u(R.isCompleted,!1))).orderBy(R.sessionDate)}async function Ze(t,e,r){let s=await l();s&&await s.update(R).set({...r,updatedAt:new Date}).where(v(u(R.id,t),u(R.userId,e)))}async function Ct(t,e){let r=await l();r&&await r.delete(R).where(v(u(R.id,t),u(R.userId,e)))}async function Bt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(M).values(t))[0].insertId}async function et(t){let e=await l();return e?e.select().from(M).where(v(u(M.userId,t),u(M.isActive,!0))).orderBy(M.mealTime):[]}async function jt(t,e){let r=await l();return r?r.select().from(M).where(v(u(M.horseId,t),u(M.userId,e),u(M.isActive,!0))).orderBy(M.mealTime):[]}async function Lt(t,e,r){let s=await l();s&&await s.update(M).set({...r,updatedAt:new Date}).where(v(u(M.id,t),u(M.userId,e)))}async function qt(t,e){let r=await l();r&&await r.update(M).set({isActive:!1,updatedAt:new Date}).where(v(u(M.id,t),u(M.userId,e)))}async function $t(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(Z).values(t))[0].insertId}async function tt(t){let e=await l();return e?e.select().from(Z).where(u(Z.userId,t)).orderBy(F(Z.createdAt)):[]}async function Ht(t,e){let r=await l();return r?r.select().from(Z).where(v(u(Z.horseId,t),u(Z.userId,e))).orderBy(F(Z.createdAt)):[]}async function Ft(t,e){let r=await l();r&&await r.delete(Z).where(v(u(Z.id,t),u(Z.userId,e)))}async function Mt(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(ce).values(t))[0].insertId}async function rt(t){let e=await l();if(!e)return;let r=await e.select().from(ce).where(u(ce.userId,t)).orderBy(F(ce.checkedAt)).limit(1);return r.length>0?r[0]:void 0}async function Kt(t,e=7){let r=await l();return r?r.select().from(ce).where(u(ce.userId,t)).orderBy(F(ce.checkedAt)).limit(e):[]}async function bn(t){let e=await l();if(!e)return;let r=await e.select().from(Ee).where(u(Ee.settingKey,t)).limit(1);return r.length>0?r[0]:void 0}async function Wt(t,e,r="string",s,o){let a=await l();a&&await a.insert(Ee).values({settingKey:t,settingValue:e,settingType:r,description:s,updatedBy:o}).onDuplicateKeyUpdate({set:{settingValue:e,updatedBy:o,updatedAt:new Date}})}async function Vt(){let t=await l();return t?t.select().from(Ee).orderBy(Ee.settingKey):[]}async function L(t){let e=await l();e&&await e.insert(ye).values(t)}async function Jt(t=100){let e=await l();return e?e.select().from(ye).orderBy(F(ye.createdAt)).limit(t):[]}async function Gt(t,e=50){let r=await l();return r?r.select().from(ye).where(u(ye.userId,t)).orderBy(F(ye.createdAt)).limit(e):[]}async function In(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(Ne).values(t))[0].insertId}async function An(t,e){let r=await l();r&&await r.update(Ne).set(e).where(u(Ne.id,t))}async function Yt(t=10){let e=await l();return e?e.select().from(Ne).orderBy(F(Ne.startedAt)).limit(t):[]}async function zt(){let t=await l();if(!t)return null;let[e]=await t.select({totalUsers:re`COUNT(*)`,activeUsers:re`SUM(CASE WHEN isActive = 1 THEN 1 ELSE 0 END)`,trialUsers:re`SUM(CASE WHEN subscriptionStatus = 'trial' THEN 1 ELSE 0 END)`,paidUsers:re`SUM(CASE WHEN subscriptionStatus = 'active' THEN 1 ELSE 0 END)`,overdueUsers:re`SUM(CASE WHEN subscriptionStatus = 'overdue' THEN 1 ELSE 0 END)`,suspendedUsers:re`SUM(CASE WHEN isSuspended = 1 THEN 1 ELSE 0 END)`}).from(O),[r]=await t.select({totalHorses:re`COUNT(*)`,activeHorses:re`SUM(CASE WHEN isActive = 1 THEN 1 ELSE 0 END)`}).from(T),[s]=await t.select({totalRecords:re`COUNT(*)`}).from(E),[o]=await t.select({totalSessions:re`COUNT(*)`,completedSessions:re`SUM(CASE WHEN isCompleted = 1 THEN 1 ELSE 0 END)`}).from(R);return{users:e,horses:r,healthRecords:s,trainingSessions:o}}async function Qt(t,e,r){let s=await l();if(!s)return null;try{return(await s.insert(xe).values({eventId:t,eventType:e,payload:r}))[0].insertId}catch{return null}}async function nt(t,e){let r=await l();r&&await r.update(xe).set({processed:!0,processedAt:new Date,error:e}).where(u(xe.eventId,t))}async function Xt(t){let e=await l();return e?(await e.select().from(xe).where(u(xe.eventId,t)).limit(1)).length>0:!1}async function Sn(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(ve).values(t))[0].insertId}async function En(t,e){let r=await l();return r?r.select().from(ve).where(v(u(ve.horseId,t),u(ve.userId,e))).orderBy(F(ve.dateAdministered)):[]}async function Nn(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(Re).values(t))[0].insertId}async function vn(t,e){let r=await l();return r?r.select().from(Re).where(v(u(Re.horseId,t),u(Re.userId,e))).orderBy(F(Re.dateAdministered)):[]}async function Rn(t){let e=await l();if(!e)throw new Error("Database not available");return(await e.insert(G).values(t))[0].insertId}async function xn(t,e){let r=await l();return r?r.select().from(G).where(v(u(G.horseId,t),u(G.userId,e))).orderBy(F(G.date)):[]}async function Tn(t){let e=await l();return e?e.select().from(G).where(u(G.userId,t)).orderBy(F(G.date)):[]}async function st(t){let e=await l();return e&&(await e.select().from(oe).where(v(u(oe.userId,t),ht(oe.expiresAt,new Date))).limit(1))[0]||null}async function Zt(t,e){let r=await l();if(!r)throw new Error("Database not available");await r.delete(oe).where(u(oe.userId,t)),await r.insert(oe).values({userId:t,expiresAt:e})}async function er(t){let e=await l();e&&await e.delete(oe).where(u(oe.userId,t))}async function tr(t){let e=await l();if(!e)return 0;let r=await e.select().from(V).where(u(V.userId,t)).limit(1);return r[0]?r[0].lockedUntil&&r[0].lockedUntil<new Date?(await e.update(V).set({attempts:0,lockedUntil:null}).where(u(V.userId,t)),0):r[0].attempts:0}async function rr(t){let e=await l();if(!e)return 0;let r=await e.select().from(V).where(u(V.userId,t)).limit(1);if(!r[0])return await e.insert(V).values({userId:t,attempts:1,lastAttemptAt:new Date}),1;let s=r[0].attempts+1;return await e.update(V).set({attempts:s,lastAttemptAt:new Date}).where(u(V.userId,t)),s}async function nr(t){let e=await l();e&&await e.update(V).set({attempts:0,lockedUntil:null}).where(u(V.userId,t))}async function sr(t,e){let r=await l();if(!r)return;let s=new Date(Date.now()+e*60*1e3);await r.update(V).set({lockedUntil:s}).where(u(V.userId,t))}async function or(t){let e=await l();return e&&(await e.select().from(V).where(u(V.userId,t)).limit(1))[0]?.lockedUntil||null}async function ir(t){let e=await l();if(!e)throw new Error("Database not available");let r="ep_"+Ge(4),s=Ge(32),o=r+"_"+s,a=await wt.hash(o,10);return{id:(await e.insert(N).values({userId:t.userId,stableId:t.stableId,name:t.name,keyHash:a,keyPrefix:r,permissions:t.permissions?JSON.stringify(t.permissions):null,rateLimit:t.rateLimit??100,expiresAt:t.expiresAt}))[0].insertId,key:o}}async function ar(t){let e=await l();return e?e.select({id:N.id,name:N.name,keyPrefix:N.keyPrefix,isActive:N.isActive,rateLimit:N.rateLimit,lastUsedAt:N.lastUsedAt,expiresAt:N.expiresAt,createdAt:N.createdAt}).from(N).where(u(N.userId,t)).orderBy(F(N.createdAt)):[]}async function lr(t,e){let r=await l();r&&await r.update(N).set({isActive:!1}).where(v(u(N.id,t),u(N.userId,e)))}async function dr(t,e){let r=await l();if(!r||!(await r.select().from(N).where(v(u(N.id,t),u(N.userId,e))).limit(1))[0])return null;let o="ep_"+Ge(4),a=Ge(32),d=o+"_"+a,m=await wt.hash(d,10);return await r.update(N).set({keyHash:m,keyPrefix:o}).where(v(u(N.id,t),u(N.userId,e))),{key:d}}async function cr(t,e,r){let s=await l();if(!s)return;let o={};r.name!==void 0&&(o.name=r.name),r.rateLimit!==void 0&&(o.rateLimit=r.rateLimit),r.permissions!==void 0&&(o.permissions=JSON.stringify(r.permissions)),r.isActive!==void 0&&(o.isActive=r.isActive),await s.update(N).set(o).where(v(u(N.id,t),u(N.userId,e)))}async function Dn(t){let e=await l();if(!e)return null;let r=t.substring(0,7),s=await e.select().from(N).where(v(u(N.keyPrefix,r),u(N.isActive,!0)));for(let o of s)if(await wt.compare(t,o.keyHash)){if(o.expiresAt&&o.expiresAt<new Date)return null;await e.update(N).set({lastUsedAt:new Date}).where(u(N.id,o.id));let d=o.permissions?JSON.parse(o.permissions):[];return{userId:o.userId,permissions:d}}return null}var Je,ie=ft(()=>{"use strict";Me();ee();Je=null});import"dotenv/config";import mt from"express";import{createServer as Rs}from"http";import xs from"net";import Ts from"helmet";import Ds from"express-rate-limit";import{createExpressMiddleware as _s}from"@trpc/server/adapters/express";var ne="app_session_id";var vr="Please login (10001)",Rr="You do not have required permission (10002)";ie();function _n(t){if(t.protocol==="https")return!0;let e=t.headers["x-forwarded-proto"];return e?(Array.isArray(e)?e:e.split(",")).some(s=>s.trim().toLowerCase()==="https"):!1}function ot(t){return{httpOnly:!0,path:"/",sameSite:"none",secure:_n(t)}}var ur=class extends Error{constructor(r,s){super(s);this.statusCode=r;this.name="HttpError"}};var qe=t=>new ur(403,t);ie();ee();import kn from"axios";import{parse as On}from"cookie";import{SignJWT as Pn,jwtVerify as Cn}from"jose";var pr=t=>typeof t=="string"&&t.length>0,Bn="/webdev.v1.WebDevAuthPublicService/ExchangeToken",jn="/webdev.v1.WebDevAuthPublicService/GetUserInfo",Ln="/webdev.v1.WebDevAuthPublicService/GetUserInfoWithJwt",mr=class{constructor(e){this.client=e;console.log("[OAuth] Initialized with baseURL:",y.oAuthServerUrl),y.oAuthServerUrl||console.error("[OAuth] ERROR: OAUTH_SERVER_URL is not configured! Set OAUTH_SERVER_URL environment variable.")}decodeState(e){return atob(e)}async getTokenByCode(e,r){let s={clientId:y.appId,grantType:"authorization_code",code:e,redirectUri:this.decodeState(r)},{data:o}=await this.client.post(Bn,s);return o}async getUserInfoByToken(e){let{data:r}=await this.client.post(jn,{accessToken:e.accessToken});return r}},qn=()=>kn.create({baseURL:y.oAuthServerUrl,timeout:3e4}),fr=class{client;oauthService;constructor(e=qn()){this.client=e,this.oauthService=new mr(this.client)}deriveLoginMethod(e,r){if(r&&r.length>0)return r;if(!Array.isArray(e)||e.length===0)return null;let s=new Set(e.filter(a=>typeof a=="string"));if(s.has("REGISTERED_PLATFORM_EMAIL"))return"email";if(s.has("REGISTERED_PLATFORM_GOOGLE"))return"google";if(s.has("REGISTERED_PLATFORM_APPLE"))return"apple";if(s.has("REGISTERED_PLATFORM_MICROSOFT")||s.has("REGISTERED_PLATFORM_AZURE"))return"microsoft";if(s.has("REGISTERED_PLATFORM_GITHUB"))return"github";let o=Array.from(s)[0];return o?o.toLowerCase():null}async exchangeCodeForToken(e,r){return this.oauthService.getTokenByCode(e,r)}async getUserInfo(e){let r=await this.oauthService.getUserInfoByToken({accessToken:e}),s=this.deriveLoginMethod(r?.platforms,r?.platform??r.platform??null);return{...r,platform:s,loginMethod:s}}parseCookies(e){if(!e)return new Map;let r=On(e);return new Map(Object.entries(r))}getSessionSecret(){let e=y.cookieSecret;return new TextEncoder().encode(e)}async createSessionToken(e,r={}){return this.signSession({openId:e,appId:y.appId,name:r.name||""},r)}async signSession(e,r={}){let s=Date.now(),o=r.expiresInMs??31536e6,a=Math.floor((s+o)/1e3),d=this.getSessionSecret();return new Pn({openId:e.openId,appId:e.appId,name:e.name}).setProtectedHeader({alg:"HS256",typ:"JWT"}).setExpirationTime(a).sign(d)}async verifySession(e){if(!e)return console.warn("[Auth] Missing session cookie"),null;try{let r=this.getSessionSecret(),{payload:s}=await Cn(e,r,{algorithms:["HS256"]}),{openId:o,appId:a,name:d,userId:m}=s;return typeof m=="number"?{openId:"",appId:y.appId,name:"",userId:m}:!pr(o)||!pr(a)||!pr(d)?(console.warn("[Auth] Session payload missing required fields"),null):{openId:o,appId:a,name:d}}catch(r){return console.warn("[Auth] Session verification failed",String(r)),null}}async getUserInfoWithJwt(e){let r={jwtToken:e,projectId:y.appId},{data:s}=await this.client.post(Ln,r),o=this.deriveLoginMethod(s?.platforms,s?.platform??s.platform??null);return{...s,platform:o,loginMethod:o}}async authenticateRequest(e){let s=this.parseCookies(e.headers.cookie).get(ne),o=await this.verifySession(s);if(!o)throw qe("Invalid session cookie");let a=new Date,d;if(o.userId){if(d=await X(o.userId),!d)throw qe("User not found")}else{let m=o.openId;if(d=await De(m),!d)try{let h=await this.getUserInfoWithJwt(s??"");await we({openId:h.openId,name:h.name||null,email:h.email??null,loginMethod:h.loginMethod??h.platform??null,lastSignedIn:a}),d=await De(h.openId)}catch(h){throw console.error("[Auth] Failed to sync user from OAuth:",h),qe("Failed to sync user info")}}if(!d)throw qe("User not found");return await J(d.id,{lastSignedIn:a}),d}},ae=new fr;function Ur(t,e){let r=t.query[e];return typeof r=="string"?r:void 0}function kr(t){t.get("/api/oauth/callback",async(e,r)=>{let s=Ur(e,"code"),o=Ur(e,"state");if(!s){console.error("[OAuth] Missing authorization code"),r.status(400).send(`
        <html>
          <body>
            <h1>OAuth Error</h1>
            <p>Missing authorization code. The OAuth callback requires a 'code' parameter.</p>
            <p><a href="/">Return to home</a></p>
          </body>
        </html>
      `);return}if(!o){console.error("[OAuth] Missing state parameter"),r.status(400).send(`
        <html>
          <body>
            <h1>OAuth Error</h1>
            <p>Missing state parameter. The OAuth callback requires a 'state' parameter for security.</p>
            <p><a href="/">Return to home</a></p>
          </body>
        </html>
      `);return}try{let a=await ae.exchangeCodeForToken(s,o),d=await ae.getUserInfo(a.accessToken);if(!d.openId){console.error("[OAuth] Missing openId in user info"),r.status(400).send(`
          <html>
            <body>
              <h1>OAuth Error</h1>
              <p>Unable to retrieve user identification from OAuth provider.</p>
              <p><a href="/">Return to home</a></p>
            </body>
          </html>
        `);return}await we({openId:d.openId,name:d.name||null,email:d.email??null,loginMethod:d.loginMethod??d.platform??null,lastSignedIn:new Date});let m=await ae.createSessionToken(d.openId,{name:d.name||"",expiresInMs:31536e6}),h=ot(e);r.cookie(ne,m,{...h,maxAge:31536e6}),r.redirect(302,"/")}catch(a){console.error("[OAuth] Callback failed",a);let d=h=>h.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),m=a instanceof Error?d(a.message):"Unknown error";r.status(500).send(`
        <html>
          <body>
            <h1>OAuth Authentication Failed</h1>
            <p>Failed to complete OAuth authentication: ${m}</p>
            <p>Please try logging in again or contact support if the problem persists.</p>
            <p><a href="/">Return to home</a></p>
          </body>
        </html>
      `)}})}ie();import Kn from"express";import hr from"bcrypt";import{nanoid as Lr}from"nanoid";import{SignJWT as qr}from"jose";import $n from"nodemailer";var gr={host:process.env.SMTP_HOST||"smtp.gmail.com",port:parseInt(process.env.SMTP_PORT||"587"),secure:!1,auth:{user:process.env.SMTP_USER||"",pass:process.env.SMTP_PASS||""}},Hn=process.env.SMTP_FROM||'"EquiProfile" <noreply@equiprofile.online>',yr=null;function Fn(){if(!gr.auth.user||!gr.auth.pass)return console.warn("[Email] SMTP not configured (SMTP_USER and SMTP_PASS required)"),null;if(!yr)try{yr=$n.createTransport(gr),console.log("[Email] SMTP transporter initialized")}catch(t){return console.error("[Email] Failed to initialize transporter:",t),null}return yr}async function at(t,e,r,s){let o=Fn();if(!o){console.warn("[Email] Skipping email send - SMTP not configured");return}try{await o.sendMail({from:Hn,to:t,subject:e,html:r,text:s||Mn(r)}),console.log(`[Email] Sent "${e}" to ${t}`)}catch(a){console.error(`[Email] Failed to send "${e}" to ${t}:`,a)}}async function Or(t){if(!t.email){console.warn("[Email] Cannot send welcome email - user has no email");return}let e=t.trialEndsAt?Math.ceil((t.trialEndsAt.getTime()-Date.now())/(1e3*60*60*24)):7,r="Welcome to EquiProfile!",s=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #1e40af;">Welcome to EquiProfile, ${t.name||"there"}! \u{1F434}</h1>
      
      <p>Thank you for joining EquiProfile, the comprehensive horse management platform!</p>
      
      <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2 style="margin-top: 0; color: #1e40af;">Your ${e}-Day Free Trial</h2>
        <p>You have <strong>${e} days</strong> to explore all premium features:</p>
        <ul>
          <li>\u{1F4CB} Health records and vaccination tracking</li>
          <li>\u{1F3CB}\uFE0F Training session management</li>
          <li>\u{1F37D}\uFE0F Feeding schedules and nutrition plans</li>
          <li>\u{1F4C5} Calendar and event reminders</li>
          <li>\u2601\uFE0F AI-powered weather analysis</li>
          <li>\u{1F4C4} Secure document storage</li>
        </ul>
      </div>
      
      <h3>Getting Started:</h3>
      <ol>
        <li>Add your first horse profile</li>
        <li>Log health records and vaccinations</li>
        <li>Set up feeding schedules</li>
        <li>Explore the dashboard analytics</li>
      </ol>
      
      <p style="margin-top: 30px;">
        <a href="${process.env.BASE_URL||"https://equiprofile.online"}/dashboard" 
           style="background: #1e40af; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
          Go to Dashboard
        </a>
      </p>
      
      <p style="color: #6b7280; margin-top: 30px;">
        Questions? Reply to this email or contact our support team.
      </p>
      
      <p style="color: #6b7280;">
        Best regards,<br/>
        The EquiProfile Team
      </p>
    </div>
  `;await at(t.email,r,s)}async function Pr(t,e){if(!t.email)return;let r=e==="yearly"?"Yearly":"Monthly",s=e==="yearly"?"\xA379.90/year":"\xA37.99/month",o="Payment successful - Welcome to EquiProfile Premium! \u{1F389}",a=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #10b981;">Payment Successful! \u{1F389}</h1>
      
      <p>Hi ${t.name||"there"},</p>
      
      <p>Thank you for subscribing to EquiProfile Premium! Your payment has been processed successfully.</p>
      
      <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; padding: 20px; margin: 20px 0;">
        <h2 style="margin-top: 0; color: #10b981;">Subscription Details</h2>
        <p><strong>Plan:</strong> ${r}</p>
        <p><strong>Amount:</strong> ${s}</p>
        <p><strong>Status:</strong> Active \u2705</p>
        ${t.subscriptionEndsAt?`<p><strong>Next billing date:</strong> ${t.subscriptionEndsAt.toLocaleDateString()}</p>`:""}
      </div>
      
      <p>You now have unlimited access to all premium features:</p>
      <ul>
        <li>\u2705 Unlimited horse profiles</li>
        <li>\u2705 Complete health record tracking</li>
        <li>\u2705 Training session management</li>
        <li>\u2705 Document storage (up to 5GB)</li>
        <li>\u2705 Advanced analytics and reports</li>
        <li>\u2705 Calendar and reminders</li>
        <li>\u2705 Priority support</li>
      </ul>
      
      <p style="margin-top: 30px;">
        <a href="${process.env.BASE_URL||"https://equiprofile.online"}/dashboard" 
           style="background: #1e40af; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
          Go to Dashboard
        </a>
      </p>
      
      <p style="color: #6b7280; margin-top: 30px; font-size: 14px;">
        You can manage your subscription, update payment methods, or view invoices anytime from your 
        <a href="${process.env.BASE_URL||"https://equiprofile.online"}/billing">billing page</a>.
      </p>
      
      <p style="color: #6b7280;">
        Thank you for choosing EquiProfile!<br/>
        The EquiProfile Team
      </p>
    </div>
  `;await at(t.email,o,a)}async function Cr(t,e,r){let s=`${process.env.BASE_URL||"https://equiprofile.online"}/reset-password?token=${e}`,o="Reset your EquiProfile password",a=`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #1e40af;">Password Reset Request</h1>
      
      <p>Hi ${r||"there"},</p>
      
      <p>We received a request to reset your EquiProfile password. Click the button below to create a new password:</p>
      
      <p style="text-align: center; margin: 30px 0;">
        <a href="${s}" 
           style="background: #1e40af; color: white; padding: 14px 32px; text-decoration: none; border-radius: 6px; display: inline-block; font-weight: bold;">
          Reset Password
        </a>
      </p>
      
      <p style="color: #dc2626; background: #fef2f2; padding: 15px; border-radius: 6px;">
        \u26A0\uFE0F This link will expire in <strong>1 hour</strong> for security reasons.
      </p>
      
      <p>If you didn't request a password reset, you can safely ignore this email. Your password will remain unchanged.</p>
      
      <p style="color: #6b7280; font-size: 14px; margin-top: 30px;">
        If the button doesn't work, copy and paste this link into your browser:<br/>
        <a href="${s}" style="color: #1e40af; word-break: break-all;">${s}</a>
      </p>
      
      <p style="color: #6b7280; margin-top: 30px;">
        Best regards,<br/>
        The EquiProfile Team
      </p>
    </div>
  `;await at(t,o,a)}async function Br(t){try{return await at(t,"EquiProfile Test Email",`
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h1 style="color: #1e40af;">Test Email</h1>
          <p>This is a test email from EquiProfile SMTP configuration.</p>
          <p>If you received this, your email settings are working correctly! \u2705</p>
          <p style="color: #6b7280; margin-top: 30px;">
            Sent at: ${new Date().toISOString()}
          </p>
        </div>
      `),!0}catch(e){return console.error("[Email] Test email failed:",e),!1}}function Mn(t){return t.replace(/<style[^>]*>.*<\/style>/gm,"").replace(/<script[^>]*>.*<\/script>/gm,"").replace(/<[^>]+>/gm,"").replace(/\s\s+/g," ").trim()}ee();var Ue=Kn.Router();Ue.post("/signup",async(t,e)=>{try{let{email:r,password:s,name:o}=t.body;if(!r||!s)return e.status(400).json({error:"Email and password are required"});if(s.length<8)return e.status(400).json({error:"Password must be at least 8 characters"});if(await Le(r))return e.status(400).json({error:"Email already registered"});let d=await hr.hash(s,10),m=`local_${Lr(16)}`,h=new Date;h.setDate(h.getDate()+7),await we({openId:m,email:r,passwordHash:d,name:o||null,loginMethod:"email",emailVerified:!1,subscriptionStatus:"trial",trialEndsAt:h,lastSignedIn:new Date});let S=await De(m);if(!S)return e.status(500).json({error:"Failed to create user"});let $=await new qr({userId:S.id}).setProtectedHeader({alg:"HS256"}).setExpirationTime("30d").sign(new TextEncoder().encode(y.cookieSecret));e.cookie(ne,$,{httpOnly:!0,secure:y.cookieSecure,sameSite:"lax",maxAge:720*60*60*1e3,domain:y.cookieDomain}),Or(S).catch(C=>console.error("[Auth] Failed to send welcome email:",C)),e.json({success:!0,user:{id:S.id,name:S.name,email:S.email,role:S.role}})}catch(r){console.error("[Auth] Signup error:",r),e.status(500).json({error:"Internal server error"})}});Ue.post("/login",async(t,e)=>{try{let{email:r,password:s}=t.body;if(!r||!s)return e.status(400).json({error:"Email and password are required"});let o=await Le(r);if(!o||!o.passwordHash)return e.status(401).json({error:"Invalid email or password"});if(!await hr.compare(s,o.passwordHash))return e.status(401).json({error:"Invalid email or password"});if(o.isSuspended)return e.status(403).json({error:"Account suspended",reason:o.suspendedReason});await J(o.id,{lastSignedIn:new Date});let d=await new qr({userId:o.id}).setProtectedHeader({alg:"HS256"}).setExpirationTime("30d").sign(new TextEncoder().encode(y.cookieSecret));e.cookie(ne,d,{httpOnly:!0,secure:y.cookieSecure,sameSite:"lax",maxAge:720*60*60*1e3,domain:y.cookieDomain}),e.json({success:!0,user:{id:o.id,name:o.name,email:o.email,role:o.role}})}catch(r){console.error("[Auth] Login error:",r),e.status(500).json({error:"Internal server error"})}});Ue.post("/request-reset",async(t,e)=>{try{let{email:r}=t.body;if(!r)return e.status(400).json({error:"Email is required"});let s=await Le(r);if(!s)return console.log("[Auth] Password reset requested for non-existent email:",r),e.json({success:!0,message:"If that email exists, a reset link has been sent"});let o=Lr(32),a=new Date;a.setHours(a.getHours()+1),await J(s.id,{resetToken:o,resetTokenExpiry:a}),await Cr(r,o,s.name||void 0),e.json({success:!0,message:"If that email exists, a reset link has been sent"})}catch(r){console.error("[Auth] Request reset error:",r),e.status(500).json({error:"Internal server error"})}});Ue.post("/reset-password",async(t,e)=>{try{let{token:r,password:s}=t.body;if(!r||!s)return e.status(400).json({error:"Token and password are required"});if(s.length<8)return e.status(400).json({error:"Password must be at least 8 characters"});let a=(await be()).find(m=>m.resetToken===r);if(!a)return e.status(400).json({error:"Invalid or expired reset token"});if(!a.resetTokenExpiry||a.resetTokenExpiry<new Date)return e.status(400).json({error:"Reset token has expired"});let d=await hr.hash(s,10);await J(a.id,{passwordHash:d,resetToken:null,resetTokenExpiry:null}),e.json({success:!0,message:"Password reset successful. You can now login with your new password."})}catch(r){console.error("[Auth] Reset password error:",r),e.status(500).json({error:"Internal server error"})}});Ue.post("/logout",(t,e)=>{e.clearCookie(ne,{httpOnly:!0,secure:y.cookieSecure,sameSite:"lax",domain:y.cookieDomain}),e.json({success:!0})});var $r=Ue;import Jn from"express";ee();import Wn from"stripe";import{TRPCError as Vn}from"@trpc/server";function Hr(){if(!y.enableStripe)throw new Vn({code:"PRECONDITION_FAILED",message:"Billing is disabled"})}function $e(){return y.enableStripe?process.env.STRIPE_SECRET_KEY?new Wn(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-12-15.clover",typescript:!0}):(console.warn("[Stripe] Secret key not configured"),null):(console.warn("[Stripe] Billing feature is disabled"),null)}var te={monthly:{priceId:process.env.STRIPE_MONTHLY_PRICE_ID||"",amount:799,currency:"gbp",interval:"month"},yearly:{priceId:process.env.STRIPE_YEARLY_PRICE_ID||"",amount:7990,currency:"gbp",interval:"year"}};async function lt(t,e,r,s,o,a){Hr();let d=$e();if(!d)return null;try{let m={mode:"subscription",payment_method_types:["card"],line_items:[{price:r,quantity:1}],success_url:s,cancel_url:o,metadata:{userId:t.toString()},customer_email:a?void 0:e,allow_promotion_codes:!0};a&&(m.customer=a);let h=await d.checkout.sessions.create(m);return{sessionId:h.id,url:h.url}}catch(m){return console.error("[Stripe] Failed to create checkout session:",m),null}}async function dt(t,e){Hr();let r=$e();if(!r)return null;try{return(await r.billingPortal.sessions.create({customer:t,return_url:e})).url}catch(s){return console.error("[Stripe] Failed to create portal session:",s),null}}ee();var wr=Jn.Router();wr.get("/checkout",async(t,e)=>{try{let r=await ae.authenticateRequest(t);if(!r)return e.status(401).json({error:"Unauthorized"});let s=t.query.plan;if(!s||s!=="monthly"&&s!=="yearly")return e.status(400).json({error:"Invalid plan. Must be 'monthly' or 'yearly'"});let o=s==="monthly"?te.monthly.priceId:te.yearly.priceId;if(!o)return e.status(500).json({error:"Stripe price ID not configured"});let a=await lt(r.id,r.email||"",o,`${y.baseUrl}/billing?success=true`,`${y.baseUrl}/billing?canceled=true`,r.stripeCustomerId||void 0);if(!a)return e.status(500).json({error:"Failed to create checkout session"});e.redirect(303,a.url)}catch(r){console.error("[Billing] Checkout error:",r),e.status(500).json({error:"Internal server error"})}});wr.get("/portal",async(t,e)=>{try{let r=await ae.authenticateRequest(t);if(!r)return e.status(401).json({error:"Unauthorized"});if(!r.stripeCustomerId)return e.status(400).json({error:"No Stripe customer ID found"});let s=await dt(r.stripeCustomerId,`${y.baseUrl}/billing`);if(!s)return e.status(500).json({error:"Failed to create portal session"});e.redirect(303,s)}catch(r){console.error("[Billing] Portal error:",r),e.status(500).json({error:"Internal server error"})}});var Fr=wr;import{z as Fe}from"zod";ee();import{TRPCError as ke}from"@trpc/server";var Mr=1200,Kr=2e4,Wr=t=>t.trim(),Vr=t=>typeof t=="string"&&t.trim().length>0,Gn=t=>{let e=t.endsWith("/")?t:`${t}/`;return new URL("webdevtoken.v1.WebDevService/SendNotification",e).toString()},Yn=t=>{if(!Vr(t.title))throw new ke({code:"BAD_REQUEST",message:"Notification title is required."});if(!Vr(t.content))throw new ke({code:"BAD_REQUEST",message:"Notification content is required."});let e=Wr(t.title),r=Wr(t.content);if(e.length>Mr)throw new ke({code:"BAD_REQUEST",message:`Notification title must be at most ${Mr} characters.`});if(r.length>Kr)throw new ke({code:"BAD_REQUEST",message:`Notification content must be at most ${Kr} characters.`});return{title:e,content:r}};async function Jr(t){let{title:e,content:r}=Yn(t);if(!y.forgeApiUrl)throw new ke({code:"INTERNAL_SERVER_ERROR",message:"Notification service URL is not configured."});if(!y.forgeApiKey)throw new ke({code:"INTERNAL_SERVER_ERROR",message:"Notification service API key is not configured."});let s=Gn(y.forgeApiUrl);try{let o=await fetch(s,{method:"POST",headers:{accept:"application/json",authorization:`Bearer ${y.forgeApiKey}`,"content-type":"application/json","connect-protocol-version":"1"},body:JSON.stringify({title:e,content:r})});if(!o.ok){let a=await o.text().catch(()=>"");return console.warn(`[Notification] Failed to notify owner (${o.status} ${o.statusText})${a?`: ${a}`:""}`),!1}return!0}catch(o){return console.warn("[Notification] Error calling notification service:",o),!1}}import{initTRPC as zn,TRPCError as br}from"@trpc/server";import Qn from"superjson";var He=zn.context().create({transformer:Qn}),_=He.router,Ae=He.procedure,Xn=He.middleware(async t=>{let{ctx:e,next:r}=t;if(!e.user)throw new br({code:"UNAUTHORIZED",message:vr});return r({ctx:{...e,user:e.user}})}),I=He.procedure.use(Xn),B=I.use(He.middleware(async t=>{let{ctx:e,next:r}=t;if(!e.user||e.user.role!=="admin")throw new br({code:"FORBIDDEN",message:Rr});let o=await(await Promise.resolve().then(()=>(ie(),Ie))).getAdminSession(e.user.id);if(!o||o.expiresAt<new Date)throw new br({code:"FORBIDDEN",message:"Admin session expired. Please unlock admin mode in AI Chat."});return r({ctx:{...e,user:e.user}})}));ee();var Gr=_({health:Ae.input(Fe.object({timestamp:Fe.number().min(0,"timestamp cannot be negative")})).query(()=>({ok:!0})),getFeatureFlags:Ae.query(()=>({enableStripe:y.enableStripe,enableUploads:y.enableUploads})),notifyOwner:B.input(Fe.object({title:Fe.string().min(1,"title is required"),content:Fe.string().min(1,"content is required")})).mutation(async({input:t})=>({success:await Jr(t)}))});ie();import{TRPCError as f}from"@trpc/server";import{z as n}from"zod";ee();var Yr=t=>Array.isArray(t)?t:[t],Zn=t=>{if(typeof t=="string")return{type:"text",text:t};if(t.type==="text"||t.type==="image_url"||t.type==="file_url")return t;throw new Error("Unsupported message content part")},es=t=>{let{role:e,name:r,tool_call_id:s}=t;if(e==="tool"||e==="function"){let a=Yr(t.content).map(d=>typeof d=="string"?d:JSON.stringify(d)).join(`
`);return{role:e,name:r,tool_call_id:s,content:a}}let o=Yr(t.content).map(Zn);return o.length===1&&o[0].type==="text"?{role:e,name:r,content:o[0].text}:{role:e,name:r,content:o}},ts=(t,e)=>{if(t){if(t==="none"||t==="auto")return t;if(t==="required"){if(!e||e.length===0)throw new Error("tool_choice 'required' was provided but no tools were configured");if(e.length>1)throw new Error("tool_choice 'required' needs a single tool or specify the tool name explicitly");return{type:"function",function:{name:e[0].function.name}}}return"name"in t?{type:"function",function:{name:t.name}}:t}},rs=()=>y.forgeApiUrl&&y.forgeApiUrl.trim().length>0?`${y.forgeApiUrl.replace(/\/$/,"")}/v1/chat/completions`:"https://forge.manus.im/v1/chat/completions",ns=()=>{if(!y.forgeApiKey)throw new Error("OPENAI_API_KEY is not configured")},ss=({responseFormat:t,response_format:e,outputSchema:r,output_schema:s})=>{let o=t||e;if(o){if(o.type==="json_schema"&&!o.json_schema?.schema)throw new Error("responseFormat json_schema requires a defined schema object");return o}let a=r||s;if(a){if(!a.name||!a.schema)throw new Error("outputSchema requires both name and schema");return{type:"json_schema",json_schema:{name:a.name,schema:a.schema,...typeof a.strict=="boolean"?{strict:a.strict}:{}}}}};async function Ir(t){ns();let{messages:e,tools:r,toolChoice:s,tool_choice:o,outputSchema:a,output_schema:d,responseFormat:m,response_format:h}=t,S={model:"gemini-2.5-flash",messages:e.map(es)};r&&r.length>0&&(S.tools=r);let $=ts(s||o,r);$&&(S.tool_choice=$),S.max_tokens=32768,S.thinking={budget_tokens:128};let C=ss({responseFormat:m,response_format:h,outputSchema:a,output_schema:d});C&&(S.response_format=C);let Se=await fetch(rs(),{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${y.forgeApiKey}`},body:JSON.stringify(S)});if(!Se.ok){let U=await Se.text();throw new Error(`LLM invoke failed: ${Se.status} ${Se.statusText} \u2013 ${U}`)}return await Se.json()}ee();function os(){if(!y.enableUploads)throw new Error("Uploads are disabled. Set ENABLE_UPLOADS=true to enable storage features.");let t=y.forgeApiUrl,e=y.forgeApiKey;if(!t||!e)throw new Error("Storage proxy credentials missing: set BUILT_IN_FORGE_API_URL and BUILT_IN_FORGE_API_KEY");return{baseUrl:t.replace(/\/+$/,""),apiKey:e}}function is(t,e){let r=new URL("v1/storage/upload",as(t));return r.searchParams.set("path",zr(e)),r}function as(t){return t.endsWith("/")?t:`${t}/`}function zr(t){return t.replace(/^\/+/,"")}function ls(t,e,r){let s=typeof t=="string"?new Blob([t],{type:e}):new Blob([t],{type:e}),o=new FormData;return o.append("file",s,r||"file"),o}function ds(t){return{Authorization:`Bearer ${t}`}}async function Qr(t,e,r="application/octet-stream"){let{baseUrl:s,apiKey:o}=os(),a=zr(t),d=is(s,a),m=ls(e,r,a.split("/").pop()??a),h=await fetch(d,{method:"POST",headers:ds(o),body:m});if(!h.ok){let $=await h.text().catch(()=>h.statusText);throw new Error(`Storage upload failed (${h.status} ${h.statusText}): ${$}`)}let S=(await h.json()).url;return{key:a,url:S}}import{nanoid as sn}from"nanoid";function ct(t){if(t==null)return"";let e=String(t);return e.includes(",")||e.includes('"')||e.includes(`
`)?`"${e.replace(/"/g,'""')}"`:e}function Oe(t){if(!t)return"";let e=typeof t=="string"?new Date(t):t;return isNaN(e.getTime())?"":e.toISOString().split("T")[0]}function pe(t){if(!t)return"";let e=typeof t=="string"?new Date(t):t;return isNaN(e.getTime())?"":e.toISOString().replace("T"," ").split(".")[0]}function Pe(t,e){if(t.length===0)return e.join(",")+`
`;let r=[e.map(ct).join(",")];for(let s of t){let o=e.map(a=>{let d=s[a];return d instanceof Date?ct(pe(d)):ct(typeof d=="object"&&d!==null?JSON.stringify(d):d)});r.push(o.join(","))}return r.join(`
`)}function me(t){let e=new Date().toISOString().split("T")[0];return`${t}_${e}.csv`}function Xr(t){let e=["id","name","breed","age","dateOfBirth","height","weight","color","gender","discipline","level","registrationNumber","microchipNumber","notes","createdAt"],r=t.map(s=>({...s,dateOfBirth:Oe(s.dateOfBirth),createdAt:pe(s.createdAt)}));return Pe(r,e)}function Zr(t){let e=["id","horseId","horseName","type","date","dueDate","veterinarian","diagnosis","treatment","medication","cost","notes","createdAt"],r=t.map(s=>({...s,date:Oe(s.date),dueDate:Oe(s.dueDate),createdAt:pe(s.createdAt)}));return Pe(r,e)}function en(t){let e=["id","horseId","horseName","sessionType","date","duration","exercises","performanceRating","notes","weatherConditions","completedAt","createdAt"],r=t.map(s=>({...s,date:Oe(s.date),completedAt:pe(s.completedAt),createdAt:pe(s.createdAt)}));return Pe(r,e)}function tn(t){let e=["id","horseId","horseName","competitionName","date","venue","discipline","level","placement","score","notes","createdAt"],r=t.map(s=>({...s,date:Oe(s.date),createdAt:pe(s.createdAt)}));return Pe(r,e)}function rn(t){let e=["id","horseId","horseName","feedType","brandName","quantity","unit","cost","purchaseDate","supplierName","notes","createdAt"],r=t.map(s=>({...s,purchaseDate:Oe(s.purchaseDate),createdAt:pe(s.createdAt)}));return Pe(r,e)}function nn(t){let e=["id","horseId","horseName","fileName","fileSize","fileType","category","description","uploadedAt"],r=t.map(s=>({...s,uploadedAt:pe(s.uploadedAt||s.createdAt)}));return Pe(r,e)}ie();ee();Me();import{eq as g,and as K,desc as le,sql as se,gte as cs,lte as us,or as ps,inArray as Ce}from"drizzle-orm";var b=I.use(async({ctx:t,next:e})=>{let r=await X(t.user.id);if(!r)throw new f({code:"UNAUTHORIZED",message:"User not found"});if(r.isSuspended)throw new f({code:"FORBIDDEN",message:"Your account has been suspended. Please contact support."});if(!["trial","active"].includes(r.subscriptionStatus)){if(r.subscriptionStatus==="trial"&&r.trialEndsAt&&new Date(r.trialEndsAt)<new Date)throw new f({code:"FORBIDDEN",message:"Your free trial has expired. Please subscribe to continue."});if(r.subscriptionStatus==="overdue"||r.subscriptionStatus==="expired")throw new f({code:"FORBIDDEN",message:"Your subscription has expired. Please renew to continue."})}return e({ctx:t})}),on=_({system:Gr,auth:_({me:Ae.query(t=>t.ctx.user),logout:Ae.mutation(({ctx:t})=>{let e=ot(t.req);return t.res.clearCookie(ne,{...e,maxAge:-1}),{success:!0}})}),adminUnlock:_({getStatus:I.query(async({ctx:t})=>{let e=await st(t.user.id);return{isUnlocked:e?e.expiresAt>new Date:!1,expiresAt:e?.expiresAt}}),requestUnlock:I.mutation(async({ctx:t})=>{let e=await tr(t.user.id);if(e>=5){let r=await or(t.user.id);if(r&&r>new Date)throw new f({code:"TOO_MANY_REQUESTS",message:`Too many attempts. Try again after ${r.toISOString()}`})}return{challenge:"Admin mode requires password. Enter password:",attemptsRemaining:Math.max(0,5-e)}}),submitPassword:I.input(n.object({password:n.string()})).mutation(async({ctx:t,input:e})=>{let r=process.env.ADMIN_UNLOCK_PASSWORD||"ashmor12@",s=await rr(t.user.id);if(s>5)throw await sr(t.user.id,15),new f({code:"TOO_MANY_REQUESTS",message:"Too many attempts. Account locked for 15 minutes."});if(e.password!==r)throw await L({userId:t.user.id,action:"admin_unlock_failed",entityType:"system",details:JSON.stringify({attempts:s})}),new f({code:"UNAUTHORIZED",message:"Incorrect password"});let o=new Date(Date.now()+1800*1e3);return await Zt(t.user.id,o),await nr(t.user.id),await L({userId:t.user.id,action:"admin_unlocked",entityType:"system",details:JSON.stringify({expiresAt:o})}),{success:!0,expiresAt:o}}),lock:I.mutation(async({ctx:t})=>(await er(t.user.id),{success:!0}))}),ai:_({chat:I.input(n.object({messages:n.array(n.object({role:n.enum(["system","user","assistant"]),content:n.string()}))})).mutation(async({ctx:t,input:e})=>{if(e.messages[e.messages.length-1]?.content.toLowerCase().trim()==="show admin"){if(t.user.role!=="admin")return{role:"assistant",content:"You do not have admin privileges."};let o=await st(t.user.id);return o&&o.expiresAt>new Date?{role:"assistant",content:`Admin mode is already unlocked. Session expires at ${o.expiresAt.toLocaleString()}.`}:{role:"assistant",content:`\u{1F510} **Admin Mode**

Please enter the admin password to unlock admin features.`,metadata:{adminChallenge:!0}}}return{role:"assistant",content:(await Ir({messages:e.messages.map(o=>({role:o.role,content:o.content}))})).choices[0]?.message?.content||"No response"}})}),billing:_({getPricing:Ae.query(()=>y.enableStripe?{enabled:!0,monthly:{amount:te.monthly.amount,currency:te.monthly.currency,interval:te.monthly.interval},yearly:{amount:te.yearly.amount,currency:te.yearly.currency,interval:te.yearly.interval}}:{enabled:!1,message:"Billing is disabled",monthly:null,yearly:null}),createCheckout:I.input(n.object({plan:n.enum(["monthly","yearly"])})).mutation(async({ctx:t,input:e})=>{if(!y.enableStripe)throw new f({code:"PRECONDITION_FAILED",message:"Billing is disabled"});let r=await X(t.user.id);if(!r)throw new f({code:"NOT_FOUND",message:"User not found"});let s=e.plan==="monthly"?te.monthly.priceId:te.yearly.priceId;if(!s)throw new f({code:"INTERNAL_SERVER_ERROR",message:"Stripe price ID not configured"});let o=t.req.protocol||"https",a=t.req.headers.host||"equiprofile.online",d=`${o}://${a}`,m=await lt(r.id,r.email||"",s,`${d}/dashboard?success=true`,`${d}/pricing?cancelled=true`,r.stripeCustomerId||void 0);if(!m)throw new f({code:"INTERNAL_SERVER_ERROR",message:"Failed to create checkout session"});return{url:m.url}}),createPortal:I.mutation(async({ctx:t})=>{if(!y.enableStripe)throw new f({code:"PRECONDITION_FAILED",message:"Billing is disabled"});let e=await X(t.user.id);if(!e||!e.stripeCustomerId)throw new f({code:"BAD_REQUEST",message:"No active subscription found"});let r=t.req.protocol||"https",s=t.req.headers.host||"equiprofile.online",o=`${r}://${s}`,a=await dt(e.stripeCustomerId,`${o}/dashboard`);if(!a)throw new f({code:"INTERNAL_SERVER_ERROR",message:"Failed to create portal session"});return{url:a}}),getStatus:I.query(async({ctx:t})=>{let e=await X(t.user.id);return e?{status:e.subscriptionStatus,plan:e.subscriptionPlan,trialEndsAt:e.trialEndsAt,subscriptionEndsAt:e.subscriptionEndsAt,lastPaymentAt:e.lastPaymentAt,hasActiveSubscription:["trial","active"].includes(e.subscriptionStatus)}:null})}),user:_({getProfile:I.query(async({ctx:t})=>await X(t.user.id)),updateProfile:I.input(n.object({name:n.string().optional(),phone:n.string().optional(),location:n.string().optional(),profileImageUrl:n.string().optional()})).mutation(async({ctx:t,input:e})=>(await J(t.user.id,e),await L({userId:t.user.id,action:"profile_updated",entityType:"user",entityId:t.user.id,details:JSON.stringify(e)}),{success:!0})),getSubscriptionStatus:I.query(async({ctx:t})=>{let e=await X(t.user.id);return e?{status:e.subscriptionStatus,plan:e.subscriptionPlan,trialEndsAt:e.trialEndsAt,subscriptionEndsAt:e.subscriptionEndsAt,lastPaymentAt:e.lastPaymentAt}:null}),getDashboardStats:b.query(async({ctx:t})=>{let e=await _e(t.user.id),r=await Xe(t.user.id),s=await ze(t.user.id,14),o=await rt(t.user.id);return{horseCount:e.length,upcomingSessionCount:r.length,reminderCount:s.length,latestWeather:o}})}),horses:_({list:b.query(async({ctx:t})=>_e(t.user.id)),get:b.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await vt(e.id,t.user.id);if(!r)throw new f({code:"NOT_FOUND",message:"Horse not found"});return r}),create:b.input(n.object({name:n.string().min(1),breed:n.string().optional(),age:n.number().optional(),dateOfBirth:n.string().optional(),height:n.number().optional(),weight:n.number().optional(),color:n.string().optional(),gender:n.enum(["stallion","mare","gelding"]).optional(),discipline:n.string().optional(),level:n.string().optional(),registrationNumber:n.string().optional(),microchipNumber:n.string().optional(),notes:n.string().optional(),photoUrl:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await Nt({...e,userId:t.user.id,dateOfBirth:e.dateOfBirth?new Date(e.dateOfBirth):void 0});return await L({userId:t.user.id,action:"horse_created",entityType:"horse",entityId:r,details:JSON.stringify({name:e.name})}),{id:r}}),update:b.input(n.object({id:n.number(),name:n.string().optional(),breed:n.string().optional(),age:n.number().optional(),dateOfBirth:n.string().optional(),height:n.number().optional(),weight:n.number().optional(),color:n.string().optional(),gender:n.enum(["stallion","mare","gelding"]).optional(),discipline:n.string().optional(),level:n.string().optional(),registrationNumber:n.string().optional(),microchipNumber:n.string().optional(),notes:n.string().optional(),photoUrl:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,dateOfBirth:s,...o}=e;return await Rt(r,t.user.id,{...o,dateOfBirth:s?new Date(s):void 0}),await L({userId:t.user.id,action:"horse_updated",entityType:"horse",entityId:r}),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await xt(e.id,t.user.id),await L({userId:t.user.id,action:"horse_deleted",entityType:"horse",entityId:e.id}),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await _e(t.user.id),r=Xr(e),s=me("horses");return{csv:r,filename:s,mimeType:"text/csv"}})}),healthRecords:_({listAll:b.query(async({ctx:t})=>Ye(t.user.id)),listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>Dt(e.horseId,t.user.id)),get:b.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await _t(e.id,t.user.id);if(!r)throw new f({code:"NOT_FOUND",message:"Health record not found"});return r}),create:b.input(n.object({horseId:n.number(),recordType:n.enum(["vaccination","deworming","dental","farrier","veterinary","injury","medication","other"]),title:n.string().min(1),description:n.string().optional(),recordDate:n.string(),nextDueDate:n.string().optional(),vetName:n.string().optional(),vetPhone:n.string().optional(),vetClinic:n.string().optional(),cost:n.number().optional(),documentUrl:n.string().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await Tt({...e,userId:t.user.id,recordDate:new Date(e.recordDate),nextDueDate:e.nextDueDate?new Date(e.nextDueDate):void 0});return await L({userId:t.user.id,action:"health_record_created",entityType:"health_record",entityId:r}),{id:r}}),update:b.input(n.object({id:n.number(),recordType:n.enum(["vaccination","deworming","dental","farrier","veterinary","injury","medication","other"]).optional(),title:n.string().optional(),description:n.string().optional(),recordDate:n.string().optional(),nextDueDate:n.string().optional(),vetName:n.string().optional(),vetPhone:n.string().optional(),vetClinic:n.string().optional(),cost:n.number().optional(),documentUrl:n.string().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,recordDate:s,nextDueDate:o,...a}=e;return await Ut(r,t.user.id,{...a,recordDate:s?new Date(s):void 0,nextDueDate:o?new Date(o):void 0}),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await kt(e.id,t.user.id),{success:!0})),getReminders:b.input(n.object({days:n.number().default(30)})).query(async({ctx:t,input:e})=>ze(t.user.id,e.days)),exportCSV:b.query(async({ctx:t})=>{let e=await Ye(t.user.id),r=Zr(e),s=me("health_records");return{csv:r,filename:s,mimeType:"text/csv"}})}),training:_({listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>Pt(e.horseId,t.user.id)),listAll:b.query(async({ctx:t})=>Qe(t.user.id)),getUpcoming:b.query(async({ctx:t})=>Xe(t.user.id)),create:b.input(n.object({horseId:n.number(),sessionDate:n.string(),startTime:n.string().optional(),endTime:n.string().optional(),duration:n.number().optional(),sessionType:n.enum(["flatwork","jumping","hacking","lunging","groundwork","competition","lesson","other"]),discipline:n.string().optional(),trainer:n.string().optional(),location:n.string().optional(),goals:n.string().optional(),exercises:n.string().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await Ot({...e,userId:t.user.id,sessionDate:new Date(e.sessionDate)});return await L({userId:t.user.id,action:"training_session_created",entityType:"training_session",entityId:r}),{id:r}}),update:b.input(n.object({id:n.number(),sessionDate:n.string().optional(),startTime:n.string().optional(),endTime:n.string().optional(),duration:n.number().optional(),sessionType:n.enum(["flatwork","jumping","hacking","lunging","groundwork","competition","lesson","other"]).optional(),discipline:n.string().optional(),trainer:n.string().optional(),location:n.string().optional(),goals:n.string().optional(),exercises:n.string().optional(),notes:n.string().optional(),performance:n.enum(["excellent","good","average","poor"]).optional(),weather:n.string().optional(),temperature:n.number().optional(),isCompleted:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,sessionDate:s,...o}=e;return await Ze(r,t.user.id,{...o,sessionDate:s?new Date(s):void 0}),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await Ct(e.id,t.user.id),{success:!0})),complete:b.input(n.object({id:n.number(),performance:n.enum(["excellent","good","average","poor"]).optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>(await Ze(e.id,t.user.id,{isCompleted:!0,performance:e.performance,notes:e.notes}),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await Qe(t.user.id),r=en(e),s=me("training_sessions");return{csv:r,filename:s,mimeType:"text/csv"}})}),feeding:_({listAll:b.query(async({ctx:t})=>et(t.user.id)),listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>jt(e.horseId,t.user.id)),create:b.input(n.object({horseId:n.number(),feedType:n.string().min(1),brandName:n.string().optional(),quantity:n.string().min(1),unit:n.string().optional(),mealTime:n.enum(["morning","midday","evening","night"]),frequency:n.string().optional(),specialInstructions:n.string().optional()})).mutation(async({ctx:t,input:e})=>({id:await Bt({...e,userId:t.user.id})})),update:b.input(n.object({id:n.number(),feedType:n.string().optional(),brandName:n.string().optional(),quantity:n.string().optional(),unit:n.string().optional(),mealTime:n.enum(["morning","midday","evening","night"]).optional(),frequency:n.string().optional(),specialInstructions:n.string().optional(),isActive:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,...s}=e;return await Lt(r,t.user.id,s),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await qt(e.id,t.user.id),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await et(t.user.id),r=rn(e),s=me("feeding_plans");return{csv:r,filename:s,mimeType:"text/csv"}})}),documents:_({list:b.query(async({ctx:t})=>tt(t.user.id)),listByHorse:b.input(n.object({horseId:n.number()})).query(async({ctx:t,input:e})=>Ht(e.horseId,t.user.id)),upload:b.input(n.object({fileName:n.string(),fileType:n.string(),fileSize:n.number(),fileData:n.string(),horseId:n.number().optional(),healthRecordId:n.number().optional(),category:n.enum(["health","registration","insurance","competition","other"]).optional(),description:n.string().optional()})).mutation(async({ctx:t,input:e})=>{if(!y.enableUploads)throw new f({code:"PRECONDITION_FAILED",message:"Uploads are disabled"});let r=Buffer.from(e.fileData,"base64"),s=`${t.user.id}/documents/${sn()}-${e.fileName}`,{url:o}=await Qr(s,r,e.fileType),a=await $t({userId:t.user.id,horseId:e.horseId,healthRecordId:e.healthRecordId,fileName:e.fileName,fileType:e.fileType,fileSize:e.fileSize,fileUrl:o,fileKey:s,category:e.category,description:e.description});return await L({userId:t.user.id,action:"document_uploaded",entityType:"document",entityId:a,details:JSON.stringify({fileName:e.fileName})}),{id:a,url:o}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await Ft(e.id,t.user.id),{success:!0})),exportCSV:b.query(async({ctx:t})=>{let e=await tt(t.user.id),r=nn(e),s=me("documents");return{csv:r,filename:s,mimeType:"text/csv"}})}),weather:_({analyze:b.input(n.object({location:n.string(),temperature:n.number(),humidity:n.number(),windSpeed:n.number(),precipitation:n.number().optional(),conditions:n.string(),uvIndex:n.number().optional(),visibility:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=`As an equestrian expert, analyze the following weather conditions for horse riding safety and provide a recommendation:

Location: ${e.location}
Temperature: ${e.temperature}\xB0C
Humidity: ${e.humidity}%
Wind Speed: ${e.windSpeed} km/h
Precipitation: ${e.precipitation||0} mm
Conditions: ${e.conditions}
UV Index: ${e.uvIndex||"Unknown"}
Visibility: ${e.visibility||"Unknown"} km

Please provide:
1. A riding recommendation (excellent, good, fair, poor, or not_recommended)
2. A brief explanation of the conditions
3. Any safety precautions riders should take
4. Best time of day to ride if conditions are marginal

Format your response as JSON with keys: recommendation, explanation, precautions, bestTime`,o=(await Ir({messages:[{role:"system",content:"You are an expert equestrian advisor specializing in weather safety for horse riding. Always respond with valid JSON."},{role:"user",content:r}]})).choices[0]?.message?.content,a=typeof o=="string"?o:"",d="fair";try{d=JSON.parse(a).recommendation||"fair"}catch{let m=e.precipitation??0;e.windSpeed>50||m>10?d="not_recommended":e.temperature<0||e.temperature>35?d="poor":e.windSpeed>30||m>5?d="fair":e.temperature>=10&&e.temperature<=25?d="excellent":d="good"}return await Mt({userId:t.user.id,location:e.location,temperature:e.temperature,humidity:e.humidity,windSpeed:e.windSpeed,precipitation:e.precipitation,conditions:e.conditions,uvIndex:e.uvIndex,visibility:e.visibility,ridingRecommendation:d,aiAnalysis:a}),{recommendation:d,analysis:a}}),getLatest:b.query(async({ctx:t})=>rt(t.user.id)),getHistory:b.input(n.object({limit:n.number().default(7)})).query(async({ctx:t,input:e})=>Kt(t.user.id,e.limit))}),admin:_({getUsers:B.query(async()=>be()),getUserDetails:B.input(n.object({userId:n.number()})).query(async({input:t})=>{let e=await X(t.userId);if(!e)throw new f({code:"NOT_FOUND",message:"User not found"});let r=await _e(t.userId),s=await Gt(t.userId,20);return{user:e,horses:r,activity:s}}),suspendUser:B.input(n.object({userId:n.number(),reason:n.string()})).mutation(async({ctx:t,input:e})=>(await bt(e.userId,e.reason),await L({userId:t.user.id,action:"user_suspended",entityType:"user",entityId:e.userId,details:JSON.stringify({reason:e.reason})}),{success:!0})),unsuspendUser:B.input(n.object({userId:n.number()})).mutation(async({ctx:t,input:e})=>(await It(e.userId),await L({userId:t.user.id,action:"user_unsuspended",entityType:"user",entityId:e.userId}),{success:!0})),deleteUser:B.input(n.object({userId:n.number()})).mutation(async({ctx:t,input:e})=>(await At(e.userId),await L({userId:t.user.id,action:"user_deleted",entityType:"user",entityId:e.userId}),{success:!0})),updateUserRole:B.input(n.object({userId:n.number(),role:n.enum(["user","admin"])})).mutation(async({ctx:t,input:e})=>(await J(e.userId,{role:e.role}),await L({userId:t.user.id,action:"user_role_updated",entityType:"user",entityId:e.userId,details:JSON.stringify({newRole:e.role})}),{success:!0})),getStats:B.query(async()=>zt()),getOverdueUsers:B.query(async()=>St()),getExpiredTrials:B.query(async()=>Et()),getActivityLogs:B.input(n.object({limit:n.number().default(100)})).query(async({input:t})=>Jt(t.limit)),getSettings:B.query(async()=>Vt()),updateSetting:B.input(n.object({key:n.string(),value:n.string(),type:n.enum(["string","number","boolean","json"]).optional(),description:n.string().optional()})).mutation(async({ctx:t,input:e})=>(await Wt(e.key,e.value,e.type,e.description,t.user.id),await L({userId:t.user.id,action:"setting_updated",entityType:"setting",details:JSON.stringify({key:e.key})}),{success:!0})),getBackupLogs:B.input(n.object({limit:n.number().default(10)})).query(async({input:t})=>Yt(t.limit)),apiKeys:_({list:B.query(async({ctx:t})=>ar(t.user.id)),create:B.input(n.object({name:n.string().min(1).max(100),rateLimit:n.number().min(1).max(1e4).optional(),permissions:n.array(n.string()).optional(),expiresAt:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await ir({userId:t.user.id,name:e.name,rateLimit:e.rateLimit,permissions:e.permissions,expiresAt:e.expiresAt?new Date(e.expiresAt):void 0});return await L({userId:t.user.id,action:"api_key_created",entityType:"api_key",entityId:r.id,details:JSON.stringify({name:e.name})}),r}),revoke:B.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>(await lr(e.id,t.user.id),await L({userId:t.user.id,action:"api_key_revoked",entityType:"api_key",entityId:e.id}),{success:!0})),rotate:B.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await dr(e.id,t.user.id);if(!r)throw new f({code:"NOT_FOUND",message:"API key not found"});return await L({userId:t.user.id,action:"api_key_rotated",entityType:"api_key",entityId:e.id}),r}),updateSettings:B.input(n.object({id:n.number(),name:n.string().optional(),rateLimit:n.number().optional(),permissions:n.array(n.string()).optional(),isActive:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let{id:r,...s}=e;return await cr(r,t.user.id,s),await L({userId:t.user.id,action:"api_key_updated",entityType:"api_key",entityId:r}),{success:!0}})}),getEnvHealth:B.query(()=>{let t=[{name:"DATABASE_URL",status:!!process.env.DATABASE_URL,critical:!0,conditional:!1},{name:"JWT_SECRET",status:!!process.env.JWT_SECRET,critical:!0,conditional:!1},{name:"ADMIN_UNLOCK_PASSWORD",status:!!process.env.ADMIN_UNLOCK_PASSWORD,critical:!0,conditional:!1},{name:"STRIPE_SECRET_KEY",status:!!process.env.STRIPE_SECRET_KEY,critical:y.enableStripe,conditional:!0,requiredWhen:"ENABLE_STRIPE=true"},{name:"STRIPE_WEBHOOK_SECRET",status:!!process.env.STRIPE_WEBHOOK_SECRET,critical:y.enableStripe,conditional:!0,requiredWhen:"ENABLE_STRIPE=true"},{name:"BUILT_IN_FORGE_API_URL",status:!!process.env.BUILT_IN_FORGE_API_URL,critical:y.enableUploads,conditional:!0,requiredWhen:"ENABLE_UPLOADS=true"},{name:"BUILT_IN_FORGE_API_KEY",status:!!process.env.BUILT_IN_FORGE_API_KEY,critical:y.enableUploads,conditional:!0,requiredWhen:"ENABLE_UPLOADS=true"},{name:"AWS_ACCESS_KEY_ID",status:!!process.env.AWS_ACCESS_KEY_ID,critical:!1,conditional:!1},{name:"AWS_SECRET_ACCESS_KEY",status:!!process.env.AWS_SECRET_ACCESS_KEY,critical:!1,conditional:!1},{name:"AWS_S3_BUCKET",status:!!process.env.AWS_S3_BUCKET,critical:!1,conditional:!1},{name:"OPENAI_API_KEY",status:!!process.env.OPENAI_API_KEY,critical:!1,conditional:!1},{name:"SMTP_HOST",status:!!process.env.SMTP_HOST,critical:!1,conditional:!1}];return{healthy:t.filter(r=>r.critical).every(r=>r.status),checks:t,featureFlags:{enableStripe:y.enableStripe,enableUploads:y.enableUploads},environment:process.env.NODE_ENV||"development",timestamp:new Date().toISOString()}})}),stables:_({create:b.input(n.object({name:n.string().min(1).max(200),description:n.string().optional(),location:n.string().optional(),logo:n.string().optional(),primaryColor:n.string().optional(),secondaryColor:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR",message:"Database not available"});let s=await r.insert(ue).values({...e,ownerId:t.user.id});return await r.insert(q).values({stableId:s[0].insertId,userId:t.user.id,role:"owner"}),{id:s[0].insertId}}),list:I.query(async({ctx:t})=>{let e=await l();if(!e)return[];let r=await e.select().from(q).where(g(q.userId,t.user.id));if(r.length===0)return[];let s=r.map(o=>o.stableId);return e.select().from(ue).where(K(se`id IN (${s.join(",")})`,g(ue.isActive,!0)))}),getById:I.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;if((await r.select().from(q).where(K(g(q.stableId,e.id),g(q.userId,t.user.id))).limit(1)).length===0)throw new f({code:"FORBIDDEN",message:"Access denied"});return(await r.select().from(ue).where(g(ue.id,e.id)).limit(1))[0]||null}),update:b.input(n.object({id:n.number(),name:n.string().optional(),description:n.string().optional(),location:n.string().optional(),logo:n.string().optional(),primaryColor:n.string().optional(),secondaryColor:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(q).where(K(g(q.stableId,e.id),g(q.userId,t.user.id))).limit(1);if(s.length===0||!["owner","admin"].includes(s[0].role))throw new f({code:"FORBIDDEN"});let{id:o,...a}=e;return await r.update(ue).set({...a,updatedAt:new Date}).where(g(ue.id,o)),{success:!0}}),inviteMember:b.input(n.object({stableId:n.number(),email:n.string().email(),role:n.enum(["admin","trainer","member","viewer"])})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(q).where(K(g(q.stableId,e.stableId),g(q.userId,t.user.id))).limit(1);if(s.length===0||!["owner","admin"].includes(s[0].role))throw new f({code:"FORBIDDEN"});let o=sn(32),a=new Date;return a.setDate(a.getDate()+7),await r.insert(xr).values({stableId:e.stableId,invitedByUserId:t.user.id,email:e.email,role:e.role,token:o,expiresAt:a}),{token:o,expiresAt:a}}),getMembers:I.input(n.object({stableId:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return[];if((await r.select().from(q).where(K(g(q.stableId,e.stableId),g(q.userId,t.user.id))).limit(1)).length===0)throw new f({code:"FORBIDDEN"});return r.select().from(q).where(K(g(q.stableId,e.stableId),g(q.isActive,!0)))})}),messages:_({getThreads:I.input(n.object({stableId:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(Te).where(K(g(Te.stableId,e.stableId),g(Te.isActive,!0))).orderBy(le(Te.updatedAt)):[]}),getMessages:I.input(n.object({threadId:n.number(),limit:n.number().default(50)})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(Be).where(g(Be.threadId,e.threadId)).orderBy(le(Be.createdAt)).limit(e.limit):[]}),sendMessage:I.input(n.object({threadId:n.number(),content:n.string().min(1),attachments:n.array(n.string()).optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(Be).values({threadId:e.threadId,senderId:t.user.id,content:e.content,attachments:e.attachments?JSON.stringify(e.attachments):null}))[0].insertId}}),createThread:I.input(n.object({stableId:n.number(),title:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(Te).values({stableId:e.stableId,title:e.title}))[0].insertId}})}),analytics:_({getTrainingStats:I.input(n.object({horseId:n.number().optional(),startDate:n.string().optional(),endDate:n.string().optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let s=r.select({totalSessions:se`COUNT(*)`,completedSessions:se`SUM(CASE WHEN isCompleted = 1 THEN 1 ELSE 0 END)`,totalDuration:se`SUM(duration)`,avgPerformance:se`AVG(CASE 
            WHEN performance = 'excellent' THEN 4
            WHEN performance = 'good' THEN 3
            WHEN performance = 'average' THEN 2
            WHEN performance = 'poor' THEN 1
            ELSE 0 END)`}).from(R).where(g(R.userId,t.user.id));return e.horseId&&(s=s.where(g(R.horseId,e.horseId))),(await s)[0]||null}),getHealthStats:I.input(n.object({horseId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r&&(await r.select({totalRecords:se`COUNT(*)`,upcomingReminders:se`SUM(CASE WHEN nextDueDate >= CURDATE() THEN 1 ELSE 0 END)`,overdueReminders:se`SUM(CASE WHEN nextDueDate < CURDATE() THEN 1 ELSE 0 END)`}).from(E).where(g(E.userId,t.user.id)))[0]||null}),getCostAnalysis:I.input(n.object({horseId:n.number().optional(),startDate:n.string().optional(),endDate:n.string().optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let s=await r.select({totalCost:se`SUM(costPerUnit)`}).from(gt).where(g(gt.userId,t.user.id)),o=await r.select({totalCost:se`SUM(cost)`}).from(E).where(g(E.userId,t.user.id));return{feedCosts:s[0]?.totalCost||0,healthCosts:o[0]?.totalCost||0,totalCosts:(s[0]?.totalCost||0)+(o[0]?.totalCost||0)}})}),reports:_({generate:b.input(n.object({reportType:n.enum(["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]),horseId:n.number().optional(),stableId:n.number().optional(),startDate:n.string().optional(),endDate:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s={};return{id:(await r.insert(je).values({userId:t.user.id,stableId:e.stableId,horseId:e.horseId,reportType:e.reportType,title:`${e.reportType.replace("_"," ")} Report`,reportData:JSON.stringify(s)}))[0].insertId}}),list:I.input(n.object({limit:n.number().default(20)})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(je).where(g(je.userId,t.user.id)).orderBy(le(je.generatedAt)).limit(e.limit):[]}),scheduleReport:b.input(n.object({reportType:n.enum(["monthly_summary","health_report","training_progress","cost_analysis","competition_summary"]),frequency:n.enum(["daily","weekly","monthly","quarterly"]),recipients:n.array(n.string().email()),stableId:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(Dr).values({userId:t.user.id,stableId:e.stableId,reportType:e.reportType,frequency:e.frequency,recipients:JSON.stringify(e.recipients),nextRunAt:new Date}))[0].insertId}})}),calendar:_({getEvents:I.input(n.object({startDate:n.string(),endDate:n.string(),stableId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r?r.select().from(Q).where(K(g(Q.userId,t.user.id),cs(Q.startDate,new Date(e.startDate)),us(Q.startDate,new Date(e.endDate)))).orderBy(Q.startDate):[]}),createEvent:b.input(n.object({title:n.string().min(1).max(200),description:n.string().optional(),eventType:n.enum(["training","competition","veterinary","farrier","lesson","meeting","other"]),startDate:n.string(),endDate:n.string().optional(),horseId:n.number().optional(),stableId:n.number().optional(),location:n.string().optional(),isAllDay:n.boolean().default(!1),color:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(Q).values({...e,userId:t.user.id,startDate:new Date(e.startDate),endDate:e.endDate?new Date(e.endDate):null}))[0].insertId}}),updateEvent:b.input(n.object({id:n.number(),title:n.string().optional(),description:n.string().optional(),startDate:n.string().optional(),endDate:n.string().optional(),isCompleted:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let{id:s,...o}=e;return await r.update(Q).set({...o,startDate:o.startDate?new Date(o.startDate):void 0,endDate:o.endDate?new Date(o.endDate):void 0,updatedAt:new Date}).where(K(g(Q.id,s),g(Q.userId,t.user.id))),{success:!0}}),deleteEvent:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return await r.delete(Q).where(K(g(Q.id,e.id),g(Q.userId,t.user.id))),{success:!0}})}),competitions:_({create:b.input(n.object({horseId:n.number(),competitionName:n.string().min(1).max(200),venue:n.string().optional(),date:n.string(),discipline:n.string().optional(),level:n.string().optional(),class:n.string().optional(),placement:n.string().optional(),score:n.string().optional(),notes:n.string().optional(),cost:n.number().optional(),winnings:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(G).values({...e,userId:t.user.id,date:new Date(e.date)}))[0].insertId}}),list:I.input(n.object({horseId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r?e.horseId?r.getCompetitionsByHorseId(e.horseId,t.user.id):r.getCompetitionsByUserId(t.user.id):[]}),exportCSV:b.query(async({ctx:t})=>{let e=await l();if(!e)throw new f({code:"INTERNAL_SERVER_ERROR"});let r=await e.getCompetitionsByUserId(t.user.id),s=tn(r),o=me("competitions");return{csv:s,filename:o,mimeType:"text/csv"}})}),trainingPrograms:_({listTemplates:I.query(async({ctx:t})=>{let e=await l();return e?e.select().from(j).where(ps(g(j.userId,t.user.id),g(j.isPublic,!0))).orderBy(le(j.createdAt)):[]}),createTemplate:b.input(n.object({name:n.string().min(1).max(200),description:n.string().optional(),duration:n.number().optional(),discipline:n.string().optional(),level:n.string().optional(),goals:n.string().optional(),programData:n.string(),isPublic:n.boolean().default(!1)})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(j).values({...e,userId:t.user.id}))[0].insertId}}),getTemplate:I.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let s=await r.select().from(j).where(g(j.id,e.id)).limit(1);if(s.length===0)return null;let o=s[0];return o.userId!==t.user.id&&!o.isPublic?null:o}),updateTemplate:b.input(n.object({id:n.number(),name:n.string().min(1).max(200).optional(),description:n.string().optional(),duration:n.number().optional(),discipline:n.string().optional(),level:n.string().optional(),goals:n.string().optional(),programData:n.string().optional(),isPublic:n.boolean().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let{id:s,...o}=e,a=await r.select().from(j).where(g(j.id,s)).limit(1);if(a.length===0||a[0].userId!==t.user.id)throw new f({code:"FORBIDDEN"});return await r.update(j).set(o).where(g(j.id,s)),{success:!0}}),deleteTemplate:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(j).where(g(j.id,e.id)).limit(1);if(s.length===0||s[0].userId!==t.user.id)throw new f({code:"FORBIDDEN"});return await r.delete(j).where(g(j.id,e.id)),{success:!0}}),duplicateTemplate:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(j).where(g(j.id,e.id)).limit(1);if(s.length===0)throw new f({code:"NOT_FOUND"});let o=s[0];if(o.userId!==t.user.id&&!o.isPublic)throw new f({code:"FORBIDDEN"});return{id:(await r.insert(j).values({name:`${o.name} (Copy)`,description:o.description,duration:o.duration,discipline:o.discipline,level:o.level,goals:o.goals,programData:o.programData,isPublic:!1,userId:t.user.id}))[0].insertId}}),applyTemplate:b.input(n.object({templateId:n.number(),horseId:n.number(),startDate:n.string()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(j).where(g(j.id,e.templateId)).limit(1);if(s.length===0)throw new f({code:"NOT_FOUND"});return{id:(await r.insert(Tr).values({horseId:e.horseId,userId:t.user.id,templateId:e.templateId,name:s[0].name,startDate:new Date(e.startDate),programData:s[0].programData}))[0].insertId}})}),breeding:_({createRecord:b.input(n.object({mareId:n.number(),stallionId:n.number().optional(),stallionName:n.string().optional(),breedingDate:n.string(),method:n.enum(["natural","artificial","embryo_transfer"]),veterinarianName:n.string().optional(),cost:n.number().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(x).values({...e,breedingDate:new Date(e.breedingDate)}))[0].insertId}}),list:I.input(n.object({mareId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return[];let o=(await r.select({id:horses.id}).from(horses).where(g(horses.userId,t.user.id))).map(d=>d.id);if(o.length===0)return[];let a=r.select().from(x).where(Ce(x.mareId,o));return e.mareId&&(a=r.select().from(x).where(K(Ce(x.mareId,o),g(x.mareId,e.mareId)))),a.orderBy(le(x.breedingDate))}),get:I.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return null;let o=(await r.select({id:horses.id}).from(horses).where(g(horses.userId,t.user.id))).map(d=>d.id),a=await r.select().from(x).where(K(g(x.id,e.id),Ce(x.mareId,o))).limit(1);return a.length>0?a[0]:null}),update:b.input(n.object({id:n.number(),stallionName:n.string().optional(),breedingDate:n.string().optional(),method:n.enum(["natural","artificial","embryo_transfer"]).optional(),veterinarianName:n.string().optional(),cost:n.number().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let{id:s,...o}=e,d=(await r.select({id:horses.id}).from(horses).where(g(horses.userId,t.user.id))).map(S=>S.id);if((await r.select().from(x).where(K(g(x.id,s),Ce(x.mareId,d))).limit(1)).length===0)throw new f({code:"FORBIDDEN"});let h={...o};return o.breedingDate&&(h.breedingDate=new Date(o.breedingDate)),await r.update(x).set(h).where(g(x.id,s)),{success:!0}}),delete:b.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let o=(await r.select({id:horses.id}).from(horses).where(g(horses.userId,t.user.id))).map(d=>d.id);if((await r.select().from(x).where(K(g(x.id,e.id),Ce(x.mareId,o))).limit(1)).length===0)throw new f({code:"FORBIDDEN"});return await r.delete(x).where(g(x.id,e.id)),{success:!0}}),confirmPregnancy:b.input(n.object({id:n.number(),confirmed:n.boolean(),confirmationDate:n.string().optional(),dueDate:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let o=(await r.select({id:horses.id}).from(horses).where(g(horses.userId,t.user.id))).map(m=>m.id);if((await r.select().from(x).where(K(g(x.id,e.id),Ce(x.mareId,o))).limit(1)).length===0)throw new f({code:"FORBIDDEN"});let d={pregnancyConfirmed:e.confirmed};return e.confirmationDate&&(d.confirmationDate=new Date(e.confirmationDate)),e.dueDate&&(d.dueDate=new Date(e.dueDate)),await r.update(x).set(d).where(g(x.id,e.id)),{success:!0}}),addFoal:b.input(n.object({breedingId:n.number(),birthDate:n.string(),gender:n.enum(["colt","filly"]),name:n.string().optional(),color:n.string().optional(),birthWeight:n.number().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(he).values({...e,birthDate:new Date(e.birthDate)}))[0].insertId}}),listFoals:I.input(n.object({breedingId:n.number().optional()})).query(async({ctx:t,input:e})=>{let r=await l();return r?e.breedingId?r.select().from(he).where(g(he.breedingId,e.breedingId)).orderBy(le(he.birthDate)):r.select().from(he).orderBy(le(he.birthDate)):[]}),exportCSV:b.query(async({ctx:t})=>{let e=await l();if(!e)throw new f({code:"INTERNAL_SERVER_ERROR"});let r=await e.select().from(x).where(g(x.userId,t.user.id)).orderBy(le(x.createdAt)),s=["id","mareId","stallionName","breedingDate","method","cost","pregnancyConfirmed","dueDate","notes"],o=r.map(m=>({id:m.id,mareId:m.mareId,stallionName:m.stallionName||"N/A",breedingDate:m.breedingDate?new Date(m.breedingDate).toISOString().split("T")[0]:"",method:m.method,cost:m.cost||0,pregnancyConfirmed:m.pregnancyConfirmed?"Yes":"No",dueDate:m.dueDate?new Date(m.dueDate).toISOString().split("T")[0]:"",notes:m.notes||""})),a=o.length>0?[s.join(","),...o.map(m=>s.map(h=>m[h]).join(","))].join(`
`):s.join(","),d=me("breeding_records");return{csv:a,filename:d,mimeType:"text/csv"}})}),trainerAvailability:_({create:I.input(n.object({dayOfWeek:n.number().min(0).max(6),startTime:n.string().regex(/^\d{2}:\d{2}$/),endTime:n.string().regex(/^\d{2}:\d{2}$/)})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(Y).values({trainerId:t.user.id,dayOfWeek:e.dayOfWeek,startTime:e.startTime,endTime:e.endTime,isActive:!0}))[0].insertId}}),list:I.query(async({ctx:t})=>{let e=await l();return e?e.select().from(Y).where(K(g(Y.trainerId,t.user.id),g(Y.isActive,!0))).orderBy(Y.dayOfWeek,Y.startTime):[]}),update:I.input(n.object({id:n.number(),dayOfWeek:n.number().min(0).max(6).optional(),startTime:n.string().regex(/^\d{2}:\d{2}$/).optional(),endTime:n.string().regex(/^\d{2}:\d{2}$/).optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(Y).where(g(Y.id,e.id)).limit(1);if(!s.length||s[0].trainerId!==t.user.id)throw new f({code:"NOT_FOUND"});let o={};return e.dayOfWeek!==void 0&&(o.dayOfWeek=e.dayOfWeek),e.startTime&&(o.startTime=e.startTime),e.endTime&&(o.endTime=e.endTime),await r.update(Y).set(o).where(g(Y.id,e.id)),{success:!0}}),delete:I.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(Y).where(g(Y.id,e.id)).limit(1);if(!s.length||s[0].trainerId!==t.user.id)throw new f({code:"NOT_FOUND"});return await r.update(Y).set({isActive:!1}).where(g(Y.id,e.id)),{success:!0}})}),lessonBookings:_({create:I.input(n.object({trainerId:n.number(),horseId:n.number().optional(),lessonDate:n.string(),duration:n.number(),lessonType:n.string().optional(),location:n.string().optional(),fee:n.number().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});return{id:(await r.insert(P).values({trainerId:e.trainerId,clientId:t.user.id,horseId:e.horseId,lessonDate:new Date(e.lessonDate),duration:e.duration,lessonType:e.lessonType,location:e.location,status:"scheduled",fee:e.fee,paid:!1,notes:e.notes}))[0].insertId}}),list:I.input(n.object({asTrainer:n.boolean().optional(),status:n.enum(["scheduled","completed","cancelled","no_show"]).optional()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)return[];let s=[];return e.asTrainer?s.push(g(P.trainerId,t.user.id)):s.push(g(P.clientId,t.user.id)),e.status&&s.push(g(P.status,e.status)),r.select().from(P).where(K(...s)).orderBy(le(P.lessonDate))}),get:I.input(n.object({id:n.number()})).query(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"NOT_FOUND"});let s=await r.select().from(P).where(g(P.id,e.id)).limit(1);if(!s.length)throw new f({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new f({code:"FORBIDDEN"});return o}),update:I.input(n.object({id:n.number(),lessonDate:n.string().optional(),duration:n.number().optional(),lessonType:n.string().optional(),location:n.string().optional(),status:n.enum(["scheduled","completed","cancelled","no_show"]).optional(),fee:n.number().optional(),paid:n.boolean().optional(),notes:n.string().optional()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(g(P.id,e.id)).limit(1);if(!s.length)throw new f({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new f({code:"FORBIDDEN"});let a={};return e.lessonDate&&(a.lessonDate=new Date(e.lessonDate)),e.duration&&(a.duration=e.duration),e.lessonType&&(a.lessonType=e.lessonType),e.location&&(a.location=e.location),e.status&&(a.status=e.status),e.fee!==void 0&&(a.fee=e.fee),e.paid!==void 0&&(a.paid=e.paid),e.notes&&(a.notes=e.notes),await r.update(P).set(a).where(g(P.id,e.id)),{success:!0}}),delete:I.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(g(P.id,e.id)).limit(1);if(!s.length)throw new f({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new f({code:"FORBIDDEN"});return await r.delete(P).where(g(P.id,e.id)),{success:!0}}),markCompleted:I.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(g(P.id,e.id)).limit(1);if(!s.length)throw new f({code:"NOT_FOUND"});if(s[0].trainerId!==t.user.id)throw new f({code:"FORBIDDEN"});return await r.update(P).set({status:"completed"}).where(g(P.id,e.id)),{success:!0}}),markCancelled:I.input(n.object({id:n.number()})).mutation(async({ctx:t,input:e})=>{let r=await l();if(!r)throw new f({code:"INTERNAL_SERVER_ERROR"});let s=await r.select().from(P).where(g(P.id,e.id)).limit(1);if(!s.length)throw new f({code:"NOT_FOUND"});let o=s[0];if(o.trainerId!==t.user.id&&o.clientId!==t.user.id)throw new f({code:"FORBIDDEN"});return await r.update(P).set({status:"cancelled"}).where(g(P.id,e.id)),{success:!0}})})});ie();Me();import{Router as ms}from"express";import{eq as fe,desc as ut}from"drizzle-orm";var ge=ms();async function fs(t,e,r){let s=t.headers.authorization;if(!s||!s.startsWith("Bearer "))return e.status(401).json({error:"Missing or invalid authorization header"});if(!s.substring(7))return e.status(401).json({error:"API key is required"});try{if(!await l())return e.status(500).json({error:"Database connection failed"});t.apiUserId=1,r()}catch(a){return console.error("API key verification error:",a),e.status(500).json({error:"Internal server error"})}}ge.use(fs);ge.get("/horses",async(t,e)=>{try{let r=t.apiUserId,s=await l();if(!s)return e.status(500).json({error:"Database connection failed"});let o=await s.select().from(T).where(fe(T.userId,r)).orderBy(ut(T.createdAt));e.json({success:!0,data:o,count:o.length})}catch(r){console.error("Error fetching horses:",r),e.status(500).json({error:"Failed to fetch horses"})}});ge.get("/horses/:id",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.id);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(T).where(fe(T.id,s)).limit(1);if(!a.length)return e.status(404).json({error:"Horse not found"});if(a[0].userId!==r)return e.status(403).json({error:"Access denied"});e.json({success:!0,data:a[0]})}catch(r){console.error("Error fetching horse:",r),e.status(500).json({error:"Failed to fetch horse"})}});ge.get("/health-records/:horseId",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.horseId);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(T).where(fe(T.id,s)).limit(1);if(!a.length||a[0].userId!==r)return e.status(403).json({error:"Access denied"});let d=await o.select().from(E).where(fe(E.horseId,s)).orderBy(ut(E.recordDate));e.json({success:!0,data:d,count:d.length})}catch(r){console.error("Error fetching health records:",r),e.status(500).json({error:"Failed to fetch health records"})}});ge.get("/training-sessions/:horseId",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.horseId);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(T).where(fe(T.id,s)).limit(1);if(!a.length||a[0].userId!==r)return e.status(403).json({error:"Access denied"});let d=await o.select().from(R).where(fe(R.horseId,s)).orderBy(ut(R.sessionDate));e.json({success:!0,data:d,count:d.length})}catch(r){console.error("Error fetching training sessions:",r),e.status(500).json({error:"Failed to fetch training sessions"})}});ge.get("/competitions/:horseId",async(t,e)=>{try{let r=t.apiUserId,s=parseInt(t.params.horseId);if(isNaN(s))return e.status(400).json({error:"Invalid horse ID"});let o=await l();if(!o)return e.status(500).json({error:"Database connection failed"});let a=await o.select().from(T).where(fe(T.id,s)).limit(1);if(!a.length||a[0].userId!==r)return e.status(403).json({error:"Access denied"});let d=await o.select().from(G).where(fe(G.horseId,s)).orderBy(ut(G.date));e.json({success:!0,data:d,count:d.length})}catch(r){console.error("Error fetching competitions:",r),e.status(500).json({error:"Failed to fetch competitions"})}});function gs(t){if(!t)return!1;if(t.role==="admin"||t.subscriptionStatus==="active")return!0;if(t.subscriptionStatus==="trial"&&t.trialEndsAt){let e=new Date;if(new Date(t.trialEndsAt)>e)return!0}return!1}async function an(t){let e=null;try{e=await ae.authenticateRequest(t.req)}catch{e=null}return{req:t.req,res:t.res,user:e,hasAccess:gs(e)}}import Es from"express";import dn from"fs";import{nanoid as Ns}from"nanoid";import pt from"path";import{createServer as vs}from"vite";import{jsxLocPlugin as ys}from"@builder.io/vite-plugin-jsx-loc";import hs from"@tailwindcss/vite";import ws from"@vitejs/plugin-react";import Ar from"node:fs";import de from"path";import{defineConfig as bs}from"vite";import{vitePluginManusRuntime as Is}from"vite-plugin-manus-runtime";function As(){return{name:"inject-service-worker-version",apply:"build",generateBundle(){let t=de.resolve(import.meta.dirname,"package.json"),r=JSON.parse(Ar.readFileSync(t,"utf-8")).version||"1.0.0",s=de.resolve(import.meta.dirname,"client/public/service-worker.js");if(Ar.existsSync(s)){let o=Ar.readFileSync(s,"utf-8");o=o.replace(/const CACHE_VERSION = ['"]([^'"]+)['"]/,`const CACHE_VERSION = '${r}'`),this.emitFile({type:"asset",fileName:"service-worker.js",source:o})}}}}var Ss=[ws(),hs(),ys(),Is(),As()],ln=bs({plugins:Ss,resolve:{alias:{"@":de.resolve(import.meta.dirname,"client","src"),"@shared":de.resolve(import.meta.dirname,"shared"),"@assets":de.resolve(import.meta.dirname,"attached_assets")}},envDir:de.resolve(import.meta.dirname),root:de.resolve(import.meta.dirname,"client"),publicDir:de.resolve(import.meta.dirname,"client","public"),build:{outDir:de.resolve(import.meta.dirname,"dist/public"),emptyOutDir:!0},server:{host:!0,allowedHosts:[".manuspre.computer",".manus.computer",".manus-asia.computer",".manuscomputer.ai",".manusvm.computer","localhost","127.0.0.1"],fs:{strict:!0,deny:["**/.*"]}}});async function cn(t,e){let s=await vs({...ln,configFile:!1,server:{middlewareMode:!0,hmr:{server:e},allowedHosts:!0},appType:"custom"});t.use(s.middlewares),t.use("*",async(o,a,d)=>{let m=o.originalUrl;try{let h=pt.resolve(import.meta.dirname,"../..","client","index.html"),S=await dn.promises.readFile(h,"utf-8");S=S.replace('src="/src/main.tsx"',`src="/src/main.tsx?v=${Ns()}"`);let $=await s.transformIndexHtml(m,S);a.status(200).set({"Content-Type":"text/html"}).end($)}catch(h){s.ssrFixStacktrace(h),d(h)}})}function un(t){let e=process.env.NODE_ENV==="development"?pt.resolve(import.meta.dirname,"../..","dist","public"):pt.resolve(import.meta.dirname,"public");dn.existsSync(e)||console.error(`Could not find the build directory: ${e}, make sure to build the client first`),t.use(Es.static(e)),t.use("*",(r,s)=>{s.sendFile(pt.resolve(e,"index.html"))})}ie();import{nanoid as Us}from"nanoid";ee();import{resolve as ks}from"path";function Os(t){return new Promise(e=>{let r=xs.createServer();r.listen(t,()=>{r.close(()=>e(!0))}),r.on("error",()=>e(!1))})}async function Ps(t=3e3){for(let e=t;e<t+20;e++)if(await Os(e))return e;throw new Error(`No available port found starting from ${t}`)}async function Cs(){let t=mt(),e=Rs(t);t.set("trust proxy",1),console.log("\u2705 Trust proxy enabled for reverse proxy support"),t.use(Ts({contentSecurityPolicy:process.env.NODE_ENV==="production"?void 0:!1,crossOriginEmbedderPolicy:!1})),t.use((d,m,h)=>{d.headers["x-request-id"]=d.headers["x-request-id"]||Us(),m.setHeader("X-Request-ID",d.headers["x-request-id"]),h()}),t.use((d,m,h)=>{let S=Date.now();m.on("finish",()=>{let $=Date.now()-S;console.log(`[${d.headers["x-request-id"]}] ${d.method} ${d.path} ${m.statusCode} ${$}ms`)}),h()});let r=Ds({windowMs:parseInt(process.env.RATE_LIMIT_WINDOW_MS||"900000"),max:parseInt(process.env.RATE_LIMIT_MAX_REQUESTS||"100"),message:"Too many requests from this IP, please try again later.",standardHeaders:!0,legacyHeaders:!1});t.use("/api",r),t.post("/api/webhooks/stripe",mt.raw({type:"application/json"}),async(d,m)=>{let h=$e();if(!h)return m.status(500).json({error:"Stripe not configured"});let S=d.headers["stripe-signature"],$=process.env.STRIPE_WEBHOOK_SECRET;if(!S||!$)return m.status(400).json({error:"Missing signature or secret"});let C;try{C=h.webhooks.constructEvent(d.body,S,$)}catch(U){return console.error("[Stripe Webhook] Signature verification failed:",U.message),m.status(400).json({error:`Webhook signature verification failed: ${U.message}`})}if(await Xt(C.id))return console.log(`[Stripe Webhook] Event ${C.id} already processed`),m.json({received:!0,cached:!0});await Qt(C.id,C.type,JSON.stringify(C.data.object));try{switch(C.type){case"checkout.session.completed":{let U=C.data.object,H=parseInt(U.metadata?.userId||"0");if(H&&U.customer&&U.subscription){let Sr=(await h.subscriptions.retrieve(U.subscription)).items.data[0]?.price.recurring?.interval==="year"?"yearly":"monthly";await J(H,{stripeCustomerId:U.customer,stripeSubscriptionId:U.subscription,subscriptionStatus:"active",subscriptionPlan:Sr,lastPaymentAt:new Date});let Er=await X(H);Er&&Pr(Er,Sr).catch(pn=>console.error("[Stripe Webhook] Failed to send payment email:",pn)),console.log(`[Stripe Webhook] User ${H} subscription activated`)}break}case"customer.subscription.updated":{let U=C.data.object,H=await s(U.id);if(H){let z="active";U.status==="past_due"&&(z="overdue"),(U.status==="canceled"||U.status==="unpaid")&&(z="cancelled"),U.status==="incomplete_expired"&&(z="expired"),await J(H,{subscriptionStatus:z,subscriptionEndsAt:U.cancel_at?new Date(U.cancel_at*1e3):null}),console.log(`[Stripe Webhook] User ${H} subscription updated to ${z}`)}break}case"customer.subscription.deleted":{let U=C.data.object,H=await s(U.id);H&&(await J(H,{subscriptionStatus:"cancelled",subscriptionEndsAt:new Date}),console.log(`[Stripe Webhook] User ${H} subscription cancelled`));break}case"invoice.payment_succeeded":{let H=C.data.object.subscription;if(H){let z=await s(H);z&&(await J(z,{subscriptionStatus:"active",lastPaymentAt:new Date}),console.log(`[Stripe Webhook] User ${z} payment succeeded`))}break}case"invoice.payment_failed":{let H=C.data.object.subscription;if(H){let z=await s(H);z&&(await J(z,{subscriptionStatus:"overdue"}),console.log(`[Stripe Webhook] User ${z} payment failed`))}break}default:console.log(`[Stripe Webhook] Unhandled event type: ${C.type}`)}await nt(C.id),m.json({received:!0})}catch(U){console.error(`[Stripe Webhook] Error processing event ${C.id}:`,U),await nt(C.id,U.message),m.status(500).json({error:"Webhook processing failed"})}});async function s(d){return(await be()).find(S=>S.stripeSubscriptionId===d)?.id||null}t.use(mt.json({limit:"50mb"})),t.use(mt.urlencoded({limit:"50mb",extended:!0})),t.get("/healthz",(d,m)=>{m.json({ok:!0,timestamp:new Date().toISOString()})}),t.get("/build",(d,m)=>{let h=JSON.parse(Nr("fs").readFileSync(ks(process.cwd(),"package.json"),"utf-8")),S="unknown";try{let{execSync:$}=Nr("child_process");S=$("git rev-parse HEAD",{encoding:"utf-8"}).trim().slice(0,7)}catch{}m.json({version:h.version||"1.0.0",buildId:process.env.BUILD_ID||"dev",commit:S,buildTime:process.env.BUILD_TIME||new Date().toISOString(),nodeVersion:process.version})}),t.get("/api/health",async(d,m)=>{let h=!!await l(),S=!!$e(),$=!!(y.oAuthServerUrl&&y.appId),C=process.env.npm_package_version||"1.0.0";m.json({status:"healthy",timestamp:new Date().toISOString(),version:C,services:{database:h,stripe:S,oauth:$}})}),t.get("/api/oauth/status",(d,m)=>{let h=!!(y.oAuthServerUrl&&y.appId);m.json({configured:h,baseUrl:y.baseUrl,oauthServerUrl:h?y.oAuthServerUrl:null})}),kr(t),t.use("/api/auth",$r),t.use("/api/billing",Fr),t.post("/api/admin/send-test-email",async(d,m)=>{try{let{to:h}=d.body;if(!h)return m.status(400).json({error:"Email address required"});let S=await Br(h);m.json({success:S,message:S?"Test email sent":"Failed to send email (check SMTP config)"})}catch(h){console.error("[Admin] Test email error:",h),m.status(500).json({error:"Internal server error"})}}),t.use("/api/trpc",_s({router:on,createContext:an})),t.use("/api/v1",ge),process.env.NODE_ENV==="development"?await cn(t,e):un(t);let o=parseInt(process.env.PORT||"3000"),a=await Ps(o);a!==o&&console.log(`Port ${o} is busy, using port ${a} instead`),e.listen(a,()=>{console.log(`Server running on http://localhost:${a}/`)})}Cs().catch(console.error);
